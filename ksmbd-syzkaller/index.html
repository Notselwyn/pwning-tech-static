<!DOCTYPE html>
<html lang="en" class="dark-mode">
<head>

    <title>Tickling ksmbd: fuzzing SMB in the Linux kernel</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <link rel="preload" as="style" href="/assets/built/screen.css?v=50a5a782cf" />
    <link rel="preload" as="script" href="/assets/built/casper.js?v=50a5a782cf" />

    <link rel="stylesheet" type="text/css" href="/assets/built/screen.css?v=50a5a782cf" />

    <meta name="description" content="Following the adventure of manually discovering network-based vulnerabilities in the Linux kernel, I&#x27;m adding ksmbd-fuzzing functionality to the already extensive kernel-fuzzing tool that is Syzkaller.">
    <link rel="icon" href="https://pwning.tech/content/images/size/w256h256/format/png/2024/01/favicon-1.webp" type="image/png">
    <link rel="canonical" href="https://pwning.tech/ksmbd-syzkaller/">
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <meta property="og:site_name" content="Pwning Tech">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Tickling ksmbd: fuzzing SMB in the Linux kernel">
    <meta property="og:description" content="Following the adventure of manually discovering network-based vulnerabilities in the Linux kernel, I&#x27;m adding ksmbd-fuzzing functionality to the already extensive kernel-fuzzing tool that is Syzkaller.">
    <meta property="og:url" content="https://pwning.tech/ksmbd-syzkaller/">
    <meta property="og:image" content="https://pwning.tech/content/images/2024/01/publication-cover-casper-1k.webp">
    <meta property="article:published_time" content="2023-09-16T13:48:24.000Z">
    <meta property="article:modified_time" content="2024-01-02T13:18:18.000Z">
    <meta property="article:tag" content="Ksmbd">
    <meta property="article:tag" content="Syzkaller">
    <meta property="article:tag" content="Fuzzing">
    <meta property="article:tag" content="Linux Kernel">
    <meta property="article:tag" content="KCOV">
    <meta property="article:tag" content="Real World">
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Tickling ksmbd: fuzzing SMB in the Linux kernel">
    <meta name="twitter:description" content="Following the adventure of manually discovering network-based vulnerabilities in the Linux kernel, I&#x27;m adding ksmbd-fuzzing functionality to the already extensive kernel-fuzzing tool that is Syzkaller.">
    <meta name="twitter:url" content="https://pwning.tech/ksmbd-syzkaller/">
    <meta name="twitter:image" content="https://pwning.tech/content/images/2023/12/logo_twitter_card.webp">
    <meta name="twitter:label1" content="Written by">
    <meta name="twitter:data1" content="notselwyn">
    <meta name="twitter:label2" content="Filed under">
    <meta name="twitter:data2" content="Ksmbd, Syzkaller, Fuzzing, Linux Kernel, KCOV, Real World">
    <meta name="twitter:site" content="@notselwyn">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="482">
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Pwning Tech",
        "url": "https://pwning.tech/",
        "logo": {
            "@type": "ImageObject",
            "url": "https://pwning.tech/content/images/2024/01/logo_transparent.svg"
        }
    },
    "author": {
        "@type": "Person",
        "name": "notselwyn",
        "url": "https://pwning.tech/author/notselwyn-2/",
        "sameAs": []
    },
    "headline": "Tickling ksmbd: fuzzing SMB in the Linux kernel",
    "url": "https://pwning.tech/ksmbd-syzkaller/",
    "datePublished": "2023-09-16T13:48:24.000Z",
    "dateModified": "2024-01-02T13:18:18.000Z",
    "keywords": "Ksmbd, Syzkaller, Fuzzing, Linux Kernel, KCOV, Real World",
    "description": "Following the adventure of manually discovering network-based vulnerabilities in the Linux kernel, I&#x27;m adding ksmbd-fuzzing functionality to the already extensive kernel-fuzzing tool that is Syzkaller.",
    "mainEntityOfPage": "https://pwning.tech/ksmbd-syzkaller/"
}
    </script>

    <meta name="generator" content="Ghost 5.75">
    <link rel="alternate" type="application/rss+xml" title="Pwning Tech" href="https://pwning.tech/rss/">
    
    <script defer src="https://cdn.jsdelivr.net/ghost/sodo-search@~1.1/umd/sodo-search.min.js" data-key="edf92d97a2ffbb07659fa25625" data-styles="https://cdn.jsdelivr.net/ghost/sodo-search@~1.1/umd/main.css" data-sodo-search="https://pwning.tech/" crossorigin="anonymous"></script>
    
    <link href="https://pwning.tech/webmentions/receive/" rel="webmention">
    <script defer src="/public/cards.min.js?v=50a5a782cf"></script>
    <link rel="stylesheet" type="text/css" href="/public/cards.min.css?v=50a5a782cf">
    <link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdnjs.cloudflare.com/ajax/libs/prism-themes/1.9.0/prism-vsc-dark-plus.min.css" integrity="sha512-ML8rkwYTFNcblPFx+VLgFIT2boa6f8DDP6p6go4+FT0/mJ8DCbCgi6S0UdjtzB3hKCr1zhU+YVB0AHhIloZP8Q==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-highlight/prism-line-highlight.min.css" integrity="sha512-nXlJLUeqPMp1Q3+Bd8Qds8tXeRVQscMscwysJm821C++9w6WtsFbJjPenZ8cQVMXyqSAismveQJc0C1splFDCA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" integrity="sha512-W/zrbCncQnky/EzL+/AYwTtosvrM+YG/V6piQLSe2HuKS6cmbw89kjYkp3tWFn1dkWV7L1ruvJyKbLz73Vlgfg==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<style>
    .gh-head-menu .nav-twitter a,
    .gh-head-menu .nav-github a {
        font-size: 0 !important;
    }

    .gh-head-menu .nav-twitter a::before,
    .gh-head-menu .nav-github a::before {
        font-family: "Font Awesome 6 Brands";
        display: inline-block;
        font-size: 20px;
        font-style: normal;
        font-weight: normal;
        font-variant: normal;
        text-rendering: auto;
        font-smoothing: antialiased;
    }

    .gh-head-menu .nav-twitter a::before {content: "\f099"}
    .gh-head-menu .nav-github a::before {content: "\f09b"}
</style>

<!-- Tocbot Stylesheet -->
<link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.12.3/tocbot.css" />

<!-- Tocbot Inline CSS (Specific Adjustments for the Casper Theme) -->
<style>
   
.gh-content {
    position: relative;
 }

.gh-toc > .toc-list {
    position: relative;
    overflow: hidden;
    padding-left: 10px;
}
    
.toc-list-item a {
    text-decoration: none;
}
    
.toc-list-item {  
    list-style: none !important;
}
    
.toc-list {    
    margin-left: 20px;
}

@media (min-width: 1300px) {
     .gh-sidebar {
        position: absolute; 
        top: 0;
        bottom: 0;
        margin-top: 4vmin;
		margin-left: 20px;
        grid-column: 1 / 3;
    }
   
    .gh-toc {
        position: sticky;
        top: 4vmin;
    }
    
    /* compensate ToC margin (required for scrolling) */
    .article-header {
     	padding-bottom: 10px;   
    }
}

.gh-toc .is-active-link::before {
    background-color: var(--ghost-accent-color);
}
</style>

<style>
	/* fix cover image of blogpost (make it inline with the text) */
	.gh-canvas .article-image {
     	grid-column: 3/3;   
    }
</style>

<style>
  /* set font of entire website */
  body { font-family: @import url(https://fonts.bunny.net/css?family=noto-sans:400,600), sans-serif; }
  h1 h2 h3 h4 h5 h6 { font-family: @import url(https://fonts.bunny.net/css?family=noto-sans:600), sans-serif; }
</style><style>:root {--ghost-accent-color: #e01b24;}</style>

</head>
<body class="post-template tag-ksmbd tag-syzkaller tag-fuzzing tag-linux-kernel tag-kcov tag-real-world tag-hash-import-2023-09-17-13-10 tag-hash-import-2023-12-29-22-15 is-head-left-logo has-sans-body has-cover">
<div class="viewport">

    <header id="gh-head" class="gh-head outer">
        <div class="gh-head-inner inner">
            <div class="gh-head-brand">
                <a class="gh-head-logo" href="https://pwning.tech">
                        <img src="https://pwning.tech/content/images/2024/01/logo_transparent.svg" alt="Pwning Tech">
                </a>
                <button class="gh-search gh-icon-btn" aria-label="Search this site" data-ghost-search><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></button>
                <button class="gh-burger"></button>
            </div>

            <nav class="gh-head-menu">
                <ul class="nav">
    <li class="nav-home"><a href="https://pwning.tech/">Home</a></li>
    <li class="nav-about-me"><a href="https://pwning.tech/about/">About Me</a></li>
    <li class="nav-twitter"><a href="https://twitter.com/notselwyn/">Twitter</a></li>
    <li class="nav-github"><a href="https://github.com/notselwyn/">Github</a></li>
</ul>

            </nav>

            <div class="gh-head-actions">
                        <button class="gh-search gh-icon-btn" data-ghost-search><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></button>
            </div>
        </div>
    </header>

    <div class="site-content">
        



<main id="site-main" class="site-main">
<article class="article post tag-ksmbd tag-syzkaller tag-fuzzing tag-linux-kernel tag-kcov tag-real-world tag-hash-import-2023-09-17-13-10 tag-hash-import-2023-12-29-22-15 featured no-image ">

    <header class="article-header gh-canvas">

        <div class="article-tag post-card-tags">
                <span class="post-card-primary-tag">
                    <a href="/tag/ksmbd/">Ksmbd</a>
                </span>
                <span class="post-card-featured"><svg width="16" height="17" viewBox="0 0 16 17" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M4.49365 4.58752C3.53115 6.03752 2.74365 7.70002 2.74365 9.25002C2.74365 10.6424 3.29678 11.9778 4.28134 12.9623C5.26591 13.9469 6.60127 14.5 7.99365 14.5C9.38604 14.5 10.7214 13.9469 11.706 12.9623C12.6905 11.9778 13.2437 10.6424 13.2437 9.25002C13.2437 6.00002 10.9937 3.50002 9.16865 1.68127L6.99365 6.25002L4.49365 4.58752Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
</svg> Featured</span>
        </div>

        <h1 class="article-title">Tickling ksmbd: fuzzing SMB in the Linux kernel</h1>

            <p class="article-excerpt">Following the adventure of manually discovering network-based vulnerabilities in the Linux kernel, I&#x27;m adding ksmbd-fuzzing functionality to the already extensive kernel-fuzzing tool that is Syzkaller.</p>

        <div class="article-byline">
        <section class="article-byline-content">

            <ul class="author-list">
                <li class="author-list-item">
                    <a href="/author/notselwyn-2/" class="author-avatar author-profile-image"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M3.513 18.998C4.749 15.504 8.082 13 12 13s7.251 2.504 8.487 5.998C18.47 21.442 15.417 23 12 23s-6.47-1.558-8.487-4.002zM12 12c2.21 0 4-2.79 4-5s-1.79-4-4-4-4 1.79-4 4 1.79 5 4 5z" fill="#FFF"/></g></svg>
</a>
                </li>
            </ul>

            <div class="article-byline-meta">
                <h4 class="author-name"><a href="/author/notselwyn-2/">notselwyn</a></h4>
                <div class="byline-meta-content">
                    <time class="byline-meta-date" datetime="2023-09-16">Sep 16, 2023</time>
                        <span class="byline-reading-time"><span class="bull">&bull;</span> 7 min read</span>
                </div>
            </div>

        </section>
        </div>


    </header>

    <section class="gh-content gh-canvas">
        <p>This blogpost is the next installment of my series of hands-on no-boilerplate vulnerability research blogposts, intended for time-travelers in the future who want to do Linux kernel vulnerability research for bugs. In this blogpost I'm discussing adding psuedo-syscalls and struct definitions for ksmbd to Syzkaller, setting up an working ksmbd instance, and patching ksmbd in order to collect KCOV. Let's dive in!</p><h2 id="1-what-are-syzkaller-and-kcov">1. What are Syzkaller and KCOV?</h2><p>Syzkaller is an unsupervised coverage-guided kernel fuzzer, or put differently: it throws generated input at a kernel (through system calls, network packets, et cetera) based on educated-guesses in order to find bugs in that kernel. Syzkaller has builtin support for several kernels, such as Windows, Linux and OpenBSD. A full list can be found in <a href="https://github.com/google/syzkaller">Syzkaller's Github repository</a>.</p><p>Syzkaller partially bases its prioritization on KCOV (kernel coverage) since it assumes that more coverage = more bugs. For a full explanation of Syzkaller and KCOV please refer to the <em>"Collecting network coverage â€” KCOV"</em> and <em>"Integrating into syzkaller"</em> sections of the <a href="https://xairy.io/articles/syzkaller-external-network#-collecting-network-coverage--kcov" rel="noreferrer">"Looking for Remote Code Execution bugs in the Linux kernel"</a> blogpost by Xairy.io in order to deduplicate content and keep this blogpost as technical as possible.</p><h2 id="2-adding-syzkaller-definitions-for-ksmbd">2. Adding Syzkaller definitions for ksmbd</h2><p>In order to make Syzkaller generate input in an efficient matter, we need to give it the structure of the input. For ksmbd, those inputs are SMB requests and hence we need to provide Syzkaller with the structures for SMB requests. The file with my unauthenticated ksmbd definitions can be found here: <a href="https://raw.githubusercontent.com/Notselwyn/blogpost-files/main/ksmbd-fuzzing/ksmbd.txt"><code>ksmbd.txt</code></a>.</p><p>The syntax for <em>declaring</em> Syzkaller structures and psuedo-syscalls is quite straightforward and well documented in their Github repository. For ksmbd, you can just copy <code>ksmbd.txt</code> to <code>sys/linux/ksmbd.txt</code> in the Syzkaller repository and Syzkaller will automatically index it. When defining Syzkaller structures you should be as tightly emulating the real data as possible. Hence, please note that the structures are marked as <code>[packed]</code>, which means that Syzkaller should not add <em>any</em> padding to the structure, as that will ruin the validity of the SMB request.</p><p>However, <em>defining</em> Syzkaller psuedo-syscalls is not as well documented. In order to define your own psuedo-syscalls, you need to define the functions in <code>executor/common_linux.h</code> in the Syzkaller repository. The code I added for sending the requests is (with explanation below):</p><figure class="kg-card kg-code-card"><pre><code class="language-c">#if SYZ_EXECUTOR || __NR_syz_ksmbd_send_req
#include &lt;netinet/in.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;sys/socket.h&gt;
#include &lt;sys/types.h&gt;

#define KSMBD_BUF_SIZE 16000

static long syz_ksmbd_send_req(volatile long a0, volatile long a1, volatile long a2, volatile long a3)
{
	int sockfd;
	int packet_reqlen;
	int errno;
	struct sockaddr_in serv_addr;
	char packet_req[KSMBD_BUF_SIZE]; // max frame size

	debug("[*]{syz_ksmbd_send_req} entered ksmbd send...\n");

	if (a0 == 0 || a1 == 0) {
		debug("[!]{syz_ksmbd_send_req} param empty\n");
		return -7;
	}

	sockfd = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
	if (sockfd &lt; 0) {
		debug("[!]{syz_ksmbd_send_req} failed to create socket\n");
		return -1;
	}

	memset(&amp;serv_addr, '\0', sizeof(serv_addr));
	serv_addr.sin_family = AF_INET;
	serv_addr.sin_addr.s_addr = inet_addr("127.0.0.1");
	serv_addr.sin_port = htons(445);

	errno = connect(sockfd, (struct sockaddr*)&amp;serv_addr, sizeof(serv_addr));
	if (errno &lt; 0) {
		debug("[!]{syz_ksmbd_send_req} failed to connect (err: %d)\n", errno);
		return errno ^ 0xff80000;
	}

	// prepend kcov handle to packet
	packet_reqlen = a1 + 8 &gt; KSMBD_BUF_SIZE ? KSMBD_BUF_SIZE - 8 : a1;
	*(unsigned long*)packet_req = procid + 1;
	memcpy(packet_req + 8, (char*)a0, packet_reqlen);

	if (write(sockfd, (char*)packet_req, packet_reqlen + 8) &lt; 0)
		return -4;

	if (read(sockfd, (char*)a2, a3) &lt; 0)
		return -5;

	if (close(sockfd) &lt; 0)
		return -6;

	debug("[+]{syz_ksmbd_send_req} successfully returned\n");

	return 0;
}
#endif
</code></pre><figcaption><p><span style="white-space: pre-wrap;">C source-code for </span><code spellcheck="false" style="white-space: pre-wrap;"><span>syz_ksmbd_send_req</span></code><span style="white-space: pre-wrap;">: a custom psuedo-syscall</span></p></figcaption></figure><p>The function prepends the process ID of the currently running syz-executor to a TCP packet, sends the TCP packet (like an SMB request) to 127.0.0.1:445 and receives a TCP packet (like an SMB response). Prepending the process ID to the packet has todo with kcov and will be explained in section 4.</p><p>The psuedo-syscall can be exclusively whitelisted using the following value in the Syzkaller config (the full config can be found in section 5):</p><figure class="kg-card kg-code-card"><pre><code class="language-json">}
	// ...
	"enable_syscalls": [
		"syz_ksmbd_send_req"
	],
	// ...
}</code></pre><figcaption><p><span style="white-space: pre-wrap;">A snippet of the "enable_syscalls" key in the Syzkaller config</span></p></figcaption></figure><h2 id="3-setting-up-ksmbd">3. Setting up ksmbd</h2><p>In order to interact with ksmbd, we need to send SMB packets to at 127.0.0.1:445. However when we the executor tries it, it will not able to reach it due to two reasons: </p><ol><li>Ksmbd needs to be started from userland</li><li>Networking namespaces prevent access</li></ol><p>In order to start the ksmbd TCP server in the kernel we need to kickstart it using the userland <a href="https://github.com/cifsd-team/ksmbd-tools">toolset</a>. Specifically, we need to setup an SMB user in order to start the SMB server and run the command to start the ksmbd server. In order to be able to interact with ksmbd in Syzkaller VMs, we need to run those commands in every VM at boot-time. I solved this by creating an systemctl service, which runs a script that kickstarts ksmbd.</p><figure class="kg-card kg-code-card"><pre><code class="language-toml">[Unit]
Description=Ksmbd
After=network.target
StartLimitIntervalSec=0
Type=simple
Restart=always
RestartSec=1

[Service]
User=root
Group=root
ExecStart=/root/start_ksmbd.sh

[Install]
WantedBy=multi-user.target</code></pre><figcaption><p><code spellcheck="false" style="white-space: pre-wrap;"><span>/etc/systemd/system/ksmbd.service</span></code><span style="white-space: pre-wrap;">: a TOML file containing a description of an systemctl service</span></p></figcaption></figure><figure class="kg-card kg-code-card"><pre><code class="language-bash">#!/usr/bin/env bash

ksmbd.addshare --add-share=files --options="path = /tmp 
read only = no"
ksmbd.adduser -a user -p password
ksmbd.mountd -n</code></pre><figcaption><p><code spellcheck="false" style="white-space: pre-wrap;"><span>/root/start_ksmbd.sh</span></code><span style="white-space: pre-wrap;">: a simple shell script that kickstarts ksmbd by running several commands</span></p></figcaption></figure><p>After enabling the service, it should be possible to connect to ksmbd using <code>nc 127.0.0.1 445 -v</code>.</p><p>Lastly, Syzkaller enables networking namespaces by default. The ksmbd service only works on 127.0.0.1:445 in the root-namespace, so the syz-executor instances will not be able to connect to ksmbd since they run in their own namespaces. To bypass this feature, I patched the Syzkaller source-code to avoid creating a network namespace:</p><pre><code class="language-diff">static int do_sandbox_none(void)
{
    // [snip]
#if SYZ_EXECUTOR || SYZ_NET_DEVICES
    initialize_netdevices_init();
#endif
+   /*
    if (unshare(CLONE_NEWNET)) {
        debug("unshare(CLONE_NEWNET): %d\n", errno);
    }
+   */
    // Enable access to IPPROTO_ICMP sockets, must be done after CLONE_NEWNET.
    write_file("/proc/sys/net/ipv4/ping_group_range", "0 65535");
+   /*
#if SYZ_EXECUTOR || SYZ_DEVLINK_PCI
    initialize_devlink_pci();
#endif
    // [snip]
#if SYZ_EXECUTOR || SYZ_NET_DEVICES
    initialize_netdevices();
#endif
+   */
#if SYZ_EXECUTOR || SYZ_WIFI
    initialize_wifi_devices();
#endif
    setup_binderfs();

+   /*
    int netns = open("/proc/1/ns/net", O_RDONLY);
    // [snip]
    close(netns);
+   */

    loop();
    doexit(1);
}
#endif</code></pre><p>Now, the syz-executor instances run in the (same) root-namespace which means that the ksmbd service is available at 127.0.0.1:445 for syz-executor instances.</p><h2 id="4-adding-kcov-support-to-ksmbd">4. Adding KCOV support to ksmbd</h2><p>When we try to fuzz ksmbd using the Syzkaller setup demonstrated above in section 2 and section 3 we will notice that the Syzkaller coverage page will not show any coverage in ksmbd, even though it gets valid SMB response. The result of that is that Syzkaller will not generate input based on the amount of ksmbd code reached and the compared request values. We do not get any KCOV because the execution flow of sending our SMB request starts at sys_send() and passes through the networking stack, where soft interrupt requests (softirq's) handles sending and receiving the packet. Because interrupt contexts do not have a process context assigned, they do not support KCOV and stop coverage tracking. Therefore, we need to <em>either</em>:</p><ol><li>Patch the networking subsystem to not use softirq's</li><li>Patch ksmbd to use remote KCOV</li></ol><p>I started out trying to patch the networking subsystem because I did not know about remote KCOV, but I ended up giving up due to the complexity of the networking subsystem. Hence, that left me exploring the web for alternatives: enter remote KCOV.</p><p>Remote KCOV allows you to (re)start KCOV using an identifier which the KCOV collector (like syz-fuzzer) uses to assign certain KCOV to a certain process (like syz-executor). Specifically, syz-fuzzer user the syz-executor instance PID as KCOV identifier, so we need to pass our process id to ksmbd per connection. Luckily, we can prepend the PID to our SMB packet in syz-executor without ugly side effects due to the way ksmbd works with sockets: we can execute an simple <code>read(sock_fd, &amp;pid, 8)</code> function call at the start of the TCP connection handler to acquire the process id in ksmbd. The codeblocks below contain patches for starting remote KCOV (explanation below):</p><figure class="kg-card kg-code-card"><pre><code class="language-diff">struct ksmbd_conn {
    // [snip]

+   unsigned long         kcov_handle;
};
</code></pre><figcaption><p><span style="white-space: pre-wrap;">C source-code containing a patch for the struct </span><code spellcheck="false" style="white-space: pre-wrap;"><span>ksmbd_conn</span></code></p></figcaption></figure><figure class="kg-card kg-code-card"><pre><code class="language-diff">int ksmbd_conn_handler_loop(void *p)
{
    struct ksmbd_conn *conn = (struct ksmbd_conn *)p;
    struct ksmbd_transport *t = conn-&gt;transport;
    unsigned int pdu_size, max_allowed_pdu_size;
    char hdr_buf[4] = {0,};
    int size;

    // [snip]

    if (t-&gt;ops-&gt;prepare &amp;&amp; t-&gt;ops-&gt;prepare(t))
        goto out;

+   size = t-&gt;ops-&gt;read(t, (char*)&amp;conn-&gt;kcov_handle, sizeof(conn-&gt;kcov_handle), -1);
+   if (size != sizeof(conn-&gt;kcov_handle))
+       goto out;
+
+   kcov_remote_start(conn-&gt;kcov_handle);

    conn-&gt;last_active = jiffies;
    while (ksmbd_conn_alive(conn)) {
        // [snip]
    }

+   kcov_remote_stop();

out:
    // [snip]
    return 0;
}
</code></pre><figcaption><p><span style="white-space: pre-wrap;">C source-code containing a patch for the function </span><code spellcheck="false" style="white-space: pre-wrap;"><span>ksmbd_conn_handler_loop()</span></code></p></figcaption></figure><figure class="kg-card kg-code-card"><pre><code class="language-diff">static void handle_ksmbd_work(struct work_struct *wk)
{
    struct ksmbd_work *work = container_of(wk, struct ksmbd_work, work);
    struct ksmbd_conn *conn = work-&gt;conn;

+   kcov_remote_start(conn-&gt;kcov_handle);
    atomic64_inc(&amp;conn-&gt;stats.request_served);
    
    __handle_ksmbd_work(work, conn);

    // [snip]

+   kcov_remote_stop();
}
</code></pre><figcaption><p><span style="white-space: pre-wrap;">C source-code containing a patch for the function </span><code spellcheck="false" style="white-space: pre-wrap;"><span>handle_ksmbd_work()</span></code></p></figcaption></figure><p>As you can see, we add the <code>kcov_handle</code> property to <code>struct ksmbd_conn</code> to keep track of the KCOV identifier throughout the process of handling an SMB request. Secondly, when an TCP connection gets accepted (and <code>ksmbd_conn_handler_loop</code> gets called) we instantly read the first 8 bytes to <code>kcov_handle</code>, after which the rest of the code will not notice anything with regards to the prepended data. However, <code>ksmbd_conn_handler_loop</code> itself will defer SMB requests within the TCP session so we lose KCOV yet again. Hence, we need to start KCOV again in <code>handle_ksmbd_work</code> which is called for each SMB-request related TCP packet. Luckily, we saved the <code>kcov_handle</code> in <code>struct ksmbd_conn</code> so we can easily access it to restart KCOV.</p><h2 id="5-testing-it">5. Testing it</h2><p>We can recompile syzkaller using:</p><figure class="kg-card kg-code-card"><pre><code class="language-bash">make generate -j`nproc`  # generate headers containing our psuedo-syscall
make -j`nproc`  # build binaries</code></pre><figcaption><p><span style="white-space: pre-wrap;">Linux shell commands</span></p></figcaption></figure><p>The config I used for fuzzing (it should be ironed out per system):</p><figure class="kg-card kg-code-card"><pre><code class="language-json">{
	"target": "linux/amd64",
	"http": "0.0.0.0:56741",
	"workdir": "workdir",
	"kernel_obj": "./linux-v6.4-patched",
	"image": "./image/bullseye.img",
	"sshkey": "./image/bullseye.id_rsa",
	"syzkaller": "/opt/syzkaller",
	"procs": 16,
	"type": "qemu",
	"sandbox": "none",
	"enable_syscalls": [
		"syz_ksmbd_send_req"
	],
	"vm": {
		"count": 24,
		"kernel": "./linux-v6.4-patched/arch/x86/boot/bzImage",
		"cpu": 1,
		"cmdline": "net.ifnames=0 oops=panic panic_on_warn=1 panic_on_oops=1",
		"mem": 2048
	}
}
</code></pre><figcaption><p><span style="white-space: pre-wrap;">A json datastructure containing configuration values for Syzkaller</span></p></figcaption></figure><p>When testing the Syzkaller and ksmbd setups demonstrated above, everything should run smoothly without any nasty errors or bugs. While using Syzkaller with the config above I found 4 unique bugs in an Linux 6.4 release:</p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="https://pwning.tech/content/images/2024/01/ksmbd.png" class="kg-image" alt="" loading="lazy" width="921" height="277" srcset="https://pwning.tech/content/images/size/w600/2024/01/ksmbd.png 600w, https://pwning.tech/content/images/2024/01/ksmbd.png 921w" sizes="(min-width: 720px) 720px"><figcaption><span style="white-space: pre-wrap;">The Syzkaller dashboard containing 4 unique bugs (3 times out-of-bounds read and 1 use-after-free write)</span></figcaption></figure><h2 id="6-conclusion">6. Conclusion</h2><p>I'm satisfied with how the fuzzer turned out as it allows me to fuzz unauthenticated SMB requests, but there's still a long way to go to improve the QoL of (ksmbd) fuzzing:</p><ol><li>Extending the SMB request definitions to support more commands</li><li>Implementing authentication using a psuedo-syscall that returns the session id</li></ol><p>Thank you for reading my blogpost, I hope you learned as much as I did researching and writing about these topics. For questions, job inquiries, and other things, please send an email to <a href="mailto:notselwyn@pwning.tech" rel="noreferrer">notselwyn@pwning.tech</a> (<a href="https://pwning.tech/pgp-notselwyn-pwning-tech-DE800B06B04C6635.asc" rel="noreferrer">PGP key</a>).</p>
    </section>


</article>
</main>




            <aside class="read-more-wrap outer">
                <div class="read-more inner">
                        
<article class="post-card post featured no-image">


    <div class="post-card-content">

        <a class="post-card-content-link" href="/ksmbd/">
            <header class="post-card-header">
                <div class="post-card-tags">
                        <span class="post-card-featured"><svg width="16" height="17" viewBox="0 0 16 17" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M4.49365 4.58752C3.53115 6.03752 2.74365 7.70002 2.74365 9.25002C2.74365 10.6424 3.29678 11.9778 4.28134 12.9623C5.26591 13.9469 6.60127 14.5 7.99365 14.5C9.38604 14.5 10.7214 13.9469 11.706 12.9623C12.6905 11.9778 13.2437 10.6424 13.2437 9.25002C13.2437 6.00002 10.9937 3.50002 9.16865 1.68127L6.99365 6.25002L4.49365 4.58752Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
</svg> Featured</span>
                </div>
                <h2 class="post-card-title">
                    Unleashing ksmbd: remote exploitation of the Linux kernel (ZDI-23-979, ZDI-23-980)
                </h2>
            </header>
                <div class="post-card-excerpt">December 22nd 2022: it's Christmas Thursday, one of the last workdays before the Christmas vacation starts. Whilst everyone was looking forward to opening presents from friends and family, the Zero Day Initiative decided to give the IT community a present as well: immense stress in the form of ZDI-22-1690, an</div>
        </a>

        <footer class="post-card-meta">
            <time class="post-card-meta-date" datetime="2023-08-04">Aug 4, 2023</time>
                <span class="post-card-meta-length">10 min read</span>
        </footer>

    </div>

</article>
                        
<article class="post-card post no-image">


    <div class="post-card-content">

        <a class="post-card-content-link" href="/cve-2022-46640/">
            <header class="post-card-header">
                <div class="post-card-tags">
                </div>
                <h2 class="post-card-title">
                    How I hacked IoT management apps: the story behind CVE-2022-46640
                </h2>
            </header>
                <div class="post-card-excerpt">Have you ever wondered how secure desktop applications really are? Recently, we put one of them to the test and found some critical vulnerabilities such as unauthenticated Remote Code Execution (CVE-2022-46640), Local File Inclusion and Remote Wireless Reconfiguration which allowed us to remotely compromise the Windows desktop. In this blogpost,</div>
        </a>

        <footer class="post-card-meta">
            <time class="post-card-meta-date" datetime="2023-03-08">Mar 8, 2023</time>
                <span class="post-card-meta-length">8 min read</span>
        </footer>

    </div>

</article>
                        
<article class="post-card post no-image">


    <div class="post-card-content">

        <a class="post-card-content-link" href="/cve-2022-47758/">
            <header class="post-card-header">
                <div class="post-card-tags">
                </div>
                <h2 class="post-card-title">
                    How I hacked smart lights: the story behind CVE-2022-47758
                </h2>
            </header>
                <div class="post-card-excerpt">In this blogpost, we take a closer look at our research regarding CVE-2022-47758: a critical vulnerability impacting a very large number of Internet of Things smart devices. We could leverage this vulnerability in the lamp's firmware for unauthenticated remote code execution on the entire device with the highest privileges and</div>
        </a>

        <footer class="post-card-meta">
            <time class="post-card-meta-date" datetime="2023-03-08">Mar 8, 2023</time>
                <span class="post-card-meta-length">16 min read</span>
        </footer>

    </div>

</article>
                </div>
            </aside>



    </div>

    <footer class="site-footer outer">
        <div class="inner">
            <section class="copyright"><a href="https://pwning.tech">Pwning Tech</a> &copy; 2024</section>
            <nav class="site-footer-nav">
                
            </nav>
            <div class="gh-powered-by"><a href="https://ghost.org/" target="_blank" rel="noopener">Powered by Ghost</a></div>
        </div>
    </footer>

</div>

    <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="pswp__bg"></div>

    <div class="pswp__scroll-wrap">
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>
<script
    src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
    crossorigin="anonymous">
</script>
<script src="/assets/built/casper.js?v=50a5a782cf"></script>
<script>
$(document).ready(function () {
    // Mobile Menu Trigger
    $('.gh-burger').click(function () {
        $('body').toggleClass('gh-head-open');
    });
    // FitVids - Makes video embeds responsive
    $(".gh-content").fitVids();
});
</script>

<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js" integrity="sha512-AKaNmg8COK0zEbjTdMHJAPJ0z6VeNqvRvH4/d5M4sHJbQQUToMBtodq4HaV4fa+WV2UTfoperElm66c9/8cKmQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-c.min.js" integrity="sha512-8VrjxGFLIkS0mgEmO3p46A5OkqATHhrNVwyv2V7yUeZrk1jmSDuI3SOEpC9XHEHUWEOsfzzcJeBlUkee9lKGrw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js" integrity="sha512-whYhDwtTmlC/NpZlCr6PSsAaLOrfjVg/iXAnC4H/dtiHawpShhT2SlIMbpIhT/IL/NrpdMm+Hq2C13+VKpHTYw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup-templating.min.js" integrity="sha512-+8BiRfWso6waiFDv6tEmWF8yfPGgxAtOYLDUB0rRISLwtpxkJ9lpPNUhxwWlikn3qSO+4RQyzDppi62o3ON/AA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-php.min.js" integrity="sha512-plzrTi61ltEMFf84gTVO9IkvIMfBu07bnDuahvdlIclmFWzXJ9VcRsny9d45sxFZRv3jJg/MHNyuxnUYEMxMEg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-http.min.js" integrity="sha512-3KphgbiKTzK2CNxlSgUKypipTV7tWknO5czNb+E7H4CeHOOSer2s2rIOCTuz8NsY1zm+B9tP9Ul2JX/tmdyOYg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js" integrity="sha512-QXFMVAusM85vUYDaNgcYeU3rzSlc+bTV4JvkfJhjxSHlQEo+ig53BtnGkvFTiNJh8D+wv6uWAQ2vJaVmxe8d3w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-diff.min.js" integrity="sha512-tBR4SAva+2bw36ToxaFeOEvgqxWHON25E9xp+kEBfw175sS5OusQEH8GrigKgTdHUXcKsK1yiyfo7fctBYl+rA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-toml.min.js" integrity="sha512-R9JG7uVdcjWlZvEWyP3KfxtexvT1uIlKUF/dYVmZRbvJyMobK6zGCpIM2gLVqYjLSYeL/zBjOVpP7vXxVtzfCw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js" integrity="sha512-BttltKXFyWnGZQcRWj6osIg7lbizJchuAMotOkdLxHxwt/Hyo+cl47bZU0QADg+Qt5DJwni3SbYGXeGMB5cBcw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
    $("pre").addClass("line-numbers");
</script>

<script>
      $('.gh-content').prepend('<aside class="gh-sidebar"><div class="gh-toc"></div></aside>');
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.12.3/tocbot.min.js"></script>
<script>
    tocbot.init({
        tocSelector: '.gh-toc',
        contentSelector: '.gh-content',
        headingSelector: 'h1, h2, h3, h4',
        hasInnerContainers: true,
  		collapseDepth: 2
    });
</script>

<script>
      $('.gh-toc').prepend('<h5>Table of contents</h5>');
</script>

<script>
  $('.gh-burger').attr('aria-label', 'menu button');
  $('.gh-search').attr('aria-label', 'search button');
  $(".author-name a").attr("aria-label", "author notselwyn");
  $(".author-profile-image").attr("aria-label", "author notselwyn");
</script>

</body>
</html>
